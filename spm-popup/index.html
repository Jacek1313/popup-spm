<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM ‚Äî Nagrywanie (popup)</title>
  <style>
    :root{ --bg:#0f0f10; --fg:#fff; --muted:#bbb; --ui:#1b1b1f; --acc:#4caf50; }
    html,body{ margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif; }
    .wrap{ max-width:900px; margin:0 auto; padding:16px; }
    fieldset{ border:1px solid #2b2b2f; border-radius:12px; padding:12px; margin:12px 0; }
    legend{ color:#ddd; padding:0 6px; }
    label{ display:block; margin:6px 0 2px; font-size:14px; color:#ddd; }
    input,button,textarea{ background:#121216; color:#fff; border:1px solid #2b2b2f; border-radius:10px; padding:10px; width:100%; }
    button{ cursor:pointer; font-weight:600; }
    button.primary{ background:var(--acc); border-color:var(--acc); color:#000; }
    button.inline{ width:auto; display:inline-block; margin-right:8px; }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .row>*{ flex:1 1 260px; }
    .log{ background:#0b0b0d; min-height:120px; white-space:pre-wrap; }
    .hint{ color:var(--muted); font-size:12px; }
    audio{ width:100%; margin-top:8px; background:#000; }
    .links a{ color:#9ed8ff; text-decoration:none; }
    .links a:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SPM ‚Äî nagrywanie</h1>

    <fieldset>
      <legend>Dane ucznia</legend>
      <div class="row">
        <div><label>Imiƒô</label><input id="imie"></div>
        <div><label>Nazwisko</label><input id="nazwisko"></div>
      </div>
      <div class="row">
        <div><label>E-mail</label><input id="email" type="email"></div>
        <div><label>Miejscowo≈õƒá</label><input id="miejscowosc"></div>
      </div>
      <div class="row">
        <div><label>Tytu≈Ç utworu</label><input id="tytul"></div>
      </div>
    </fieldset>

    <fieldset>
      <legend>Nagrywanie</legend>
      <div>
        <button id="btnStart" class="inline">Start</button>
        <button id="btnStop" class="inline" disabled>Stop</button>
        <button id="btnDownload" class="inline" disabled>Pobierz</button>
      </div>
      <audio id="preview" controls></audio>
      <div class="hint">Format: WebM/Opus (MediaRecorder). Pasek czasu dzia≈Ça w przeglƒÖdarce.</div>
    </fieldset>

    <fieldset>
      <legend>Wysy≈Çka na Drive</legend>
      <button id="btnUpload" class="primary inline" disabled>Wy≈õlij na Drive</button>
      <div id="driveLinks" class="links"></div>
    </fieldset>

    <fieldset>
      <legend>Przekazanie do SPM</legend>
      <button id="btnSend" class="inline" disabled>Wy≈õlij do SPM i zamknij</button>
      <button id="btnCopy" class="inline" disabled>Kopiuj token (awaryjnie)</button>
      <div class="hint">‚ÄûWy≈õlij do SPM‚Äù u≈ºywa postMessage ‚Üí strona SPM zapisze plik w bibliotece i CMS.</div>
    </fieldset>

    <fieldset>
      <legend>Log</legend>
      <pre id="log" class="log"></pre>
    </fieldset>
  </div>

<script>
  // KONFIG
  const PROXY_URL     = '/.netlify/functions/spm';         // Netlify function (proxy ‚Üí Apps Script)
  const PARENT_ORIGIN = 'https://TWOJA-DOMENA-WIX';        // <--- WSTAW: domena SPM (Wix)

  // Prefill z parametru ?q= (JSON)
  try {
    const url = new URL(location.href);
    const q = url.searchParams.get('q');
    if (q) {
      const pre = JSON.parse(decodeURIComponent(q));
      for (const k of ['imie','nazwisko','email','miejscowosc','tytul']) {
        if (pre[k]) document.getElementById(k).value = pre[k];
      }
    }
  } catch {}

  let mediaRecorder, chunks = [];
  let audioBlob = null, durationMs = 0, fileInfo = null;

  const $ = s => document.querySelector(s);
  const log = (...a)=>{ const el=$('#log'); el.textContent += a.join(' ') + '\n'; el.scrollTop = el.scrollHeight; };

  // Nagrywanie
  $('#btnStart').addEventListener('click', async () => {
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
      chunks = [];
      mediaRecorder = new MediaRecorder(stream, { mimeType:'audio/webm' });
      const t0 = performance.now();
      mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
      mediaRecorder.onstop = () => {
        const t1 = performance.now();
        durationMs = Math.round(t1 - t0);
        audioBlob = new Blob(chunks, { type:'audio/webm' });
        const url = URL.createObjectURL(audioBlob);
        const audio = $('#preview'); audio.src = url; audio.load();
        $('#btnDownload').disabled = false;
        $('#btnUpload').disabled = false;
        log('Nagrywanie OK. Czas ~', durationMs, 'ms; rozmiar ~', Math.round(audioBlob.size/1024),'KB');
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
      $('#btnStart').disabled = true; $('#btnStop').disabled = false;
      log('Nagrywanie‚Ä¶');
    }catch(err){ alert('Brak dostƒôpu do mikrofonu.'); log('getUserMedia:', err.message||err); }
  });
  $('#btnStop').addEventListener('click', () => {
    try{ if(mediaRecorder?.state==='recording') mediaRecorder.stop();
      $('#btnStop').disabled = true; $('#btnStart').disabled = false;
    }catch(e){ log('stop:', e.message||e); }
  });
  $('#btnDownload').addEventListener('click', () => {
    if(!audioBlob) return;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(audioBlob);
    a.download = buildFileName(); document.body.appendChild(a); a.click(); a.remove();
  });

  // Upload do Drive (Apps Script przez proxy)
  $('#btnUpload').addEventListener('click', async () => {
    if(!audioBlob) return alert('Brak nagrania.');
    try{
      toggle(true);
      log('Konwersja na base64‚Ä¶');
      const base64 = await blobToBase64(audioBlob);
      const payload = {
        action:'upload',
        fileBase64:base64,
        mimeType: audioBlob.type || 'audio/webm',
        fileName: buildFileName(),
        meta: readMeta()
      };
      log('Wysy≈Çanie do proxy‚Ä¶');
      const r = await fetch(PROXY_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
      const txt = await r.text();
      let data; try{ data = JSON.parse(txt); }catch{ log('RAW proxy:\n'+txt.slice(0,600)); throw new Error('Nieprawid≈Çowy JSON (proxy)'); }
      if(!data.ok){ if(data.raw) log('RAW upstream:\n'+String(data.raw).slice(0,600)); throw new Error(data.error||'Upload fail'); }
      fileInfo = data;
      $('#btnSend').disabled = false;
      $('#btnCopy').disabled = false;
      document.getElementById('driveLinks').innerHTML = `
        <div>üìÑ <a href="${data.viewLink}" target="_blank" rel="noopener">PodglƒÖd (Drive)</a></div>
        <div>‚¨áÔ∏è <a href="${data.downloadLink}" target="_blank" rel="noopener">Pobierz (direct)</a></div>
        <div class="hint">fileId: ${data.fileId}</div>`;
      log('Upload OK, fileId:', data.fileId);
    }catch(err){ alert(err.message||err); log('Upload:', err.message||err); }
    finally{ toggle(false); }
  });

  // Wy≈õlij do SPM (postMessage + zamkniƒôcie)
  $('#btnSend').addEventListener('click', () => {
    const meta = readMeta();
    if (!validateMeta(meta)) return;
    const payload = {
      ...meta,
      durationMs,
      fileId: fileInfo?.fileId || '',
      viewLink: fileInfo?.viewLink || '',
      downloadLink: fileInfo?.downloadLink || '',
      fileName: fileInfo?.name || buildFileName(),
      mimeType: fileInfo?.mimeType || (audioBlob?.type || 'audio/webm')
    };
    try {
      window.opener && window.opener.postMessage({ type:'spmUpload', payload }, PARENT_ORIGIN);
    } catch(e) {}
    window.close(); // zamknij popup
  });

  // Kopiuj (awaryjnie)
  $('#btnCopy').addEventListener('click', async () => {
    const meta = readMeta();
    if (!validateMeta(meta)) return;
    const payload = {
      ...meta,
      durationMs,
      fileId: fileInfo?.fileId || '',
      viewLink: fileInfo?.viewLink || '',
      downloadLink: fileInfo?.downloadLink || '',
      fileName: fileInfo?.name || buildFileName(),
      mimeType: fileInfo?.mimeType || (audioBlob?.type || 'audio/webm')
    };
    const token = 'SPM:' + btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    try { await navigator.clipboard.writeText(token); alert('Skopiowano token.'); }
    catch { alert('Skopiuj rƒôcznie:\n' + token); }
  });

  // Helpery
  function readMeta(){ return {
    imie:$('#imie').value.trim(),
    nazwisko:$('#nazwisko').value.trim(),
    email:$('#email').value.trim(),
    miejscowosc:$('#miejscowosc').value.trim(),
    tytul:$('#tytul').value.trim()
  }; }
  function validateMeta(m){ const miss = Object.entries(m).filter(([k,v])=>!v).map(([k])=>k);
    if(miss.length){ alert('BrakujƒÖce pola: '+miss.join(', ')); return false; } return true; }
  function slug(s){ return (s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-zA-Z0-9\-_. ]+/g,' ').trim().replace(/\s+/g,'-'); }
  function buildFileName(){
    const m = readMeta(); const now = new Date().toISOString().replace(/[:.]/g,'-');
    return `SPM-${now}-${slug(m.imie)}-${slug(m.nazwisko)}-${slug(m.tytul||'nagranie')}.webm`;
  }
  function toggle(dis){ ['#btnStart','#btnStop','#btnDownload','#btnUpload','#btnSend','#btnCopy']
    .forEach(id=>{ const el=$(id); if(el) el.disabled = dis && (id!=='#btnStop'); }); }
  function blobToBase64(blob){
    return new Promise((res,rej)=>{ const r=new FileReader();
      r.onloadend=()=>{ try{ res(String(r.result).split(',')[1]); }catch(e){ rej(e); } };
      r.onerror=rej; r.readAsDataURL(blob); });
  }
</script>
</body>
</html>
