<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM – Studio nagrań</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background:#0f0f0f; color:#f1f1f1; }
    h1{ margin: 0; font-size: 1.6rem; line-height:1.1; }
    h2{ margin: 18px 0 10px; font-size: 1.2rem; }

    /* HEADER z logo */
    .brand{
      display:flex; align-items:center; gap:14px;
      padding:8px 0 14px 0;
    }
    .brand img{ height:64px; width:auto; display:block; }
    .brand-sub{ opacity:.9; font-size:.95rem; margin-top:4px; }

    .section{ border:1px solid #262626; border-radius:12px; padding:14px; margin:14px 0; background:#141414; }
    .row{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .stack-sm{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
    .stack-sm > * { flex: 0 0 auto; }

    @media (max-width:640px){
      .row{ flex-direction:column; align-items:flex-start; }
      .stack-sm{ flex-direction:column; }
      .brand{ flex-direction:row; }
    }

    /* NAV GRID */
    .nav-grid{
      display:grid; gap:12px; align-items:start;
      grid-template-columns: 1.2fr 0.8fr;
      grid-template-areas:
        "hl hr"
        "bl br";
    }
    .nav-head-left  { grid-area: hl; }
    .nav-head-right { grid-area: hr; }
    .nav-body-left  { grid-area: bl; }
    .nav-body-right { grid-area: br; }

    .nav-head-left h2,
    .nav-head-right h2{ margin-top:0; }

    @media (max-width:900px){
      .nav-grid{
        grid-template-columns: 1fr;
        grid-template-areas:
          "hl"
          "bl"
          "hr"
          "br";
      }
    }

    input[type="range"]{ width: min(420px, 90vw); }
    .val, .time{ font-variant-numeric: tabular-nums; opacity:.9; }
    .time{ min-width:92px; text-align:right; }

    /* buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:0; background:#2e7d32; color:#fff;
      text-decoration:none; cursor:pointer; font-weight:600; box-shadow:0 0 0 0 rgba(0,0,0,0);
      transition: transform .04s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:#3d3d3d; color:#f2f2f2; }
    .btn.warn{ background:#1565c0; }
    .btn.danger{ background:#8e1b1b; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .note{ opacity:.85; font-size:.92rem; }

    /* banner */
    #banner { border:1px solid #2a2a2a; padding:10px 12px; border-radius:10px; margin-bottom:12px; text-align:center; color:#eaeaea; background:#121212; }
    @keyframes blink { 50% { opacity:.38 } }
    .blink { animation: blink .9s linear infinite; }

    /* Log */
    #log{ background:#0b0b0b; border:1px solid #202020; border-radius:12px; padding:12px; white-space:pre-wrap; }
    .log-wrap{ max-height:260px; overflow:auto; }

    /* steps */
    .step { position:relative; }
    .step::before{
      content: attr(data-step);
      position:absolute; left:-10px; top:-10px;
      background:#1e1e1e; border:1px solid #2a2a2a; color:#cfcfcf;
      padding:2px 8px; border-radius:999px; font-size:.78rem;
    }
    .step.active{ outline:2px solid #1e5e1f; outline-offset: 2px; }

    /* ===== VU-meter (POWIĘKSZONY + delikatnie czulszy) ===== */
    .vu-wrap{
      display:flex; align-items:flex-end; gap:8px;
      height:104px; /* było 68px */
      padding:8px 10px; border-radius:10px; border:1px solid #262626; background:#101010;
    }
    .vu-label{ font-size:.86rem; opacity:.85; min-width:88px; }
    .vu-bar{
      position:relative; width:16px; height:100%; border-radius:8px; background:#1f1f1f; overflow:hidden;
    }
    .vu-fill{
      position:absolute; bottom:0; left:0; right:0; height:8%;
      background: linear-gradient(180deg, #37d537 0%, #2ea62e 60%, #e0b02e 80%, #cc3a3a 100%);
      border-radius:8px;
      transition: height .06s linear;
    }
    .vu-num{ width:56px; font-variant-numeric: tabular-nums; text-align:right; opacity:.85; }
  </style>
</head>
<body>
  <div id="banner">1) <b>Nagraj</b> → 2) Wyślij → 3) Wróć do SPM – Potwierdź wysyłkę i Zapisz</div>

  <!-- NAGŁÓWEK z logo -->
  <div class="brand">
    <img src="logoSPM.png" alt="Logo Studio Piosenki Metro" />
    <div>
      <h1>SPM – Studio nagrań</h1>
      <div class="brand-sub">Nagrywanie głosu z podkładem (czysty tor mikrofonu)</div>
    </div>
  </div>

  <!-- NAWIGACJA -->
  <div class="section" id="navSection">
    <div class="nav-grid">
      <div class="nav-head-left"><h2>Nawigacja</h2></div>
      <div class="nav-head-right"><h2>Log</h2></div>

      <div class="nav-body-left">
        <div class="row" style="margin-top:6px">
          <label for="trackVol">Głośność podkładu</label>
          <input id="trackVol" type="range" min="0" max="1" step="0.01" value="0.7" />
          <span id="trackVolVal" class="val">70%</span>
        </div>

        <div class="row" style="margin-top:8px">
          <label for="backingSeek">Postęp podkładu</label>
          <input id="backingSeek" type="range" min="0" max="0" step="0.01" value="0" />
          <span id="backingTime" class="time">0:00 / 0:00</span>
        </div>

        <!-- Wybór mikrofonu -->
        <div class="row" style="margin-top:10px">
          <label for="micSelect">Mikrofon</label>
          <select id="micSelect" style="min-width:260px"></select>
          <button id="btnRefreshMics" class="btn secondary">Odśwież listę</button>
        </div>

        <audio id="backing" preload="auto" style="display:none"></audio>
        <div class="note">Podkład gra w słuchawkach podczas nagrywania. <b>Nie zapisuje się</b> w pliku — nagrywa się tylko mikrofon.</div>
      </div>

      <div class="nav-body-right">
        <div class="log-wrap"><pre id="log"></pre></div>
      </div>
    </div>
  </div>

  <!-- KROK 1 – Nagrywanie -->
  <div class="section step" id="step1" data-step="Krok 1">
    <h2>Nagrywanie</h2>

    <div class="stack-sm" style="margin:6px 0 4px; align-items:center">
      <button id="btnStart" class="btn">Start</button>
      <button id="btnStop" class="btn secondary" disabled>Stop</button>
      <button id="btnDownload" class="btn secondary" disabled>Pobierz wokal</button>

      <!-- ===== VU-meter ===== -->
      <div class="vu-wrap" title="Poziom mikrofonu (live)">
        <div class="vu-label">Mikrofon</div>
        <div class="vu-bar"><div id="vuFill" class="vu-fill"></div></div>
        <div id="vuNum" class="vu-num">-∞ dB</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px">
      <label for="playerSeek">Postęp nagrania</label>
      <input id="playerSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="playerTime" class="time">0:00 / 0:00</span>
    </div>

    <audio id="player" style="display:none"></audio>

    <div class="stack-sm" style="margin-top:10px">
      <button id="btnAudition" class="btn warn" disabled>Odsłuchaj (z podkładem)</button>
      <button id="btnStopAud" class="btn danger" disabled>Zatrzymaj odsłuch</button>

      <div class="row">
        <label for="offsetMs">Korekta przesunięcia</label>
        <input id="offsetMs" type="range" min="-800" max="800" step="10" value="0" />
        <span id="offsetVal" class="val">0 ms</span>
      </div>

      <div class="row">
        <label for="tempoPct">Korekta tempa</label>
        <input id="tempoPct" type="range" min="-1" max="1" step="0.05" value="0" />
        <span id="tempoVal" class="val">0.00%</span>
      </div>
    </div>

    <div class="note">Jeśli czujesz „rozjazd”, użyj suwaków: <b>przesunięcie</b> (ms) i <b>tempo</b> (±1%) — działa tylko w odsłuchu.</div>
  </div>

  <!-- KROK 2 – Wyślij -->
  <div class="section step" id="step2" data-step="Krok 2">
    <h2>Wyślij</h2>
    <div class="stack-sm" style="margin:6px 0 8px">
      <button id="btnSendAll" class="btn warn" disabled>Wyślij</button>
      <a id="aReturn" class="btn" href="#" style="display:none">Wróć do SPM – Potwierdź wysyłkę i Zapisz</a>
    </div>
    <div id="fileIdLine" class="note" hidden>fileId: <span id="fileIdSpan"></span></div>
  </div>

<script>
/* ========= KONFIG ========= */
const FN_URL = '/.netlify/functions/spm';
const MAX_MS = 7 * 60 * 1000;
const WARN_BEFORE_MS = 30 * 1000;

const qs            = new URLSearchParams(location.search);
const parentUrlRaw  = qs.get('parent') || '';
const PARENT_ORIGIN = parentUrlRaw ? new URL(parentUrlRaw).origin : '*';
const PARENT_URL    = parentUrlRaw || '';

/* ========= STAN ========= */
let mediaRecorder, chunks = [], recordedBlob = null, startedAt = 0, durationMs = 0;
let fileName = '', mimeType = 'audio/webm;codecs=opus';
let metaToSend = null;

const $ = id => document.getElementById(id);
const backing = $('backing');
const player  = $('player');
const backingSeek = $('backingSeek');
const playerSeek  = $('playerSeek');
const backingTime = $('backingTime');
const playerTime  = $('playerTime');
const banner = $('banner');

const micSelect = $('micSelect');
const btnRefreshMics = $('btnRefreshMics');

let offsetMs = 0, tempoPct = 0, resyncTimer = null, rafId = null, isAuditioning = false;
let isRecording = false;
let maxTimer = null, warnTimer = null;

/* ===== VU-meter state ===== */
let audioCtx = null, analyser = null, vuData = null, vuRAF = null;
const vuFill = $('vuFill'), vuNum = $('vuNum');

/* ========= UTIL ========= */
function log(m){ $('log').textContent += m + '\n'; }
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
function sanitize(s){ return (s||'').trim().replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,''); }
function blobToBase64(blob){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(blob); }); }
function parseQ(){ try{ const q=new URLSearchParams(location.search).get('q'); return q?JSON.parse(decodeURIComponent(q)) : {}; }catch(_){ return {}; } }
function fmt(t){ if(!isFinite(t)||t<0) t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${String(s).padStart(2,'0')}`; }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
function setBanner(text){ banner.textContent = text || ''; }
function stepActive(id){ try{ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); if (id) $(id).classList.add('active'); }catch(_){} }

/* ========= PREFILL ========= */
let student = { imie:'', nazwisko:'', email:'', miejscowosc:'', tytul:'', trackUrl:'' };
(function init(){
  const q = parseQ();
  student = {
    imie: q.imie || '', nazwisko: q.nazwisko || '', email: q.email || '',
    miejscowosc: q.miejscowosc || '', tytul: q.tytul || '', trackUrl: q.trackUrl || ''
  };
  if (student.trackUrl) { backing.src = student.trackUrl; backing.load(); log('Podkład ustawiony (z SPM).'); }
  setBanner('1) Nagraj → 2) Wyślij → 3) Wróć do SPM – Potwierdź wysyłkę i Zapisz');
  stepActive('step1');
  initMics();
})();

/* ========= URZĄDZENIA ========= */
async function initMics(){
  try{
    // wymaga zgody użytkownika – krótka prośba o audio:
    await navigator.mediaDevices.getUserMedia({ audio: true });
  }catch(_){}
  await listMics();
}
async function listMics(){
  try{
    const devs = await navigator.mediaDevices.enumerateDevices();
    const mics = devs.filter(d => d.kind === 'audioinput');
    micSelect.innerHTML = '';
    mics.forEach((d, i) => {
      const opt = document.createElement('option');
      opt.value = d.deviceId;
      opt.textContent = d.label || `Mikrofon ${i+1}`;
      micSelect.appendChild(opt);
    });
    if (!mics.length){
      const opt = document.createElement('option');
      opt.value = '';
      opt.textContent = 'Brak mikrofonów';
      micSelect.appendChild(opt);
    }
    log(`Mikrofony: ${mics.map(d=>d.label||d.deviceId).join(' | ') || '(brak)'}`);
  }catch(e){ log('enumerateDevices error: '+e.message); }
}
btnRefreshMics.onclick = listMics;

/* ========= PROGRESS ========= */
function refreshProgress(){
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bc = isFinite(backing.currentTime) ? backing.currentTime : 0;
  backingSeek.max = bd || 0;
  if (document.activeElement !== backingSeek) backingSeek.value = bc;
  backingTime.textContent = `${fmt(bc)} / ${fmt(bd)}`;

  const pd = isFinite(player.duration) ? player.duration : (durationMs? durationMs/1000 : 0);
  const pc = isFinite(player.currentTime) ? player.currentTime : 0;
  playerSeek.max = pd || 0;
  if (document.activeElement !== playerSeek) playerSeek.value = pc;
  playerTime.textContent = `${fmt(pc)} / ${fmt(pd)}`;

  rafId = requestAnimationFrame(refreshProgress);
}
rafId = requestAnimationFrame(refreshProgress);

playerSeek.addEventListener('input', ()=>{
  const pd = isFinite(player.duration) ? player.duration : 0;
  const t = clamp(parseFloat(playerSeek.value)||0, 0, pd||1e9);
  player.currentTime = t;
  if (isAuditioning) resyncBackingToPlayer();
});
backingSeek.addEventListener('input', ()=>{
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bt = clamp(parseFloat(backingSeek.value)||0, 0, bd||1e9);
  const targetPlayer = clamp(bt - offsetMs/1000, 0, (isFinite(player.duration)?player.duration:1e9));
  player.currentTime = targetPlayer;
  if (isAuditioning) resyncBackingToPlayer();
});

/* ========= PODKŁAD ========= */
$('trackVol').addEventListener('input', e=>{
  const v = parseFloat(e.target.value||'0.7'); backing.volume = v; $('trackVolVal').textContent = Math.round(v*100)+'%';
});
backing.volume = parseFloat($('trackVol').value||'0.7');
backing.preservesPitch = true; backing.mozPreservesPitch = true; backing.webkitPreservesPitch = true;

/* ===== VU-meter helpers ===== */
function startVU(stream){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
    const src = audioCtx.createMediaStreamSource(stream);
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 1024;
    analyser.smoothingTimeConstant = 0.6; /* nieco żywszy */
    src.connect(analyser);
    vuData = (analyser.getFloatTimeDomainData ? new Float32Array(analyser.fftSize) : new Uint8Array(analyser.fftSize));

    const loop = () => {
      if (!analyser) return;
      if (vuData instanceof Float32Array){
        analyser.getFloatTimeDomainData(vuData);
        let sum = 0; for (let i=0;i<vuData.length;i++){ const v = vuData[i]; sum += v*v; }
        const rms = Math.sqrt(sum / vuData.length);            // 0..~1
        const pct = Math.min(1, rms * 4.0);                    // było ×3.0 → czulszy
        vuFill.style.height = Math.max(0.04, pct) * 100 + '%';
        const db = rms>0 ? (20*Math.log10(rms)).toFixed(1) : '-∞';
        vuNum.textContent = (db==='-∞' ? '-∞' : db+' dB');
      } else {
        analyser.getByteTimeDomainData(vuData);
        let sum = 0; for (let i=0;i<vuData.length;i++){ const v = (vuData[i]-128)/128; sum += v*v; }
        const rms = Math.sqrt(sum / vuData.length);
        const pct = Math.min(1, rms * 4.0);                    // było ×3.0 → czulszy
        vuFill.style.height = Math.max(0.04, pct) * 100 + '%';
        const db = rms>0 ? (20*Math.log10(rms)).toFixed(1) : '-∞';
        vuNum.textContent = (db==='-∞' ? '-∞' : db+' dB');
      }
      vuRAF = requestAnimationFrame(loop);
    };
    cancelAnimationFrame(vuRAF);
    vuRAF = requestAnimationFrame(loop);
  }catch(e){
    log('VU error: '+e.message);
  }
}
function stopVU(){
  try{ cancelAnimationFrame(vuRAF); }catch(_){}
  vuRAF = null;
  analyser = null;
  vuFill.style.height = '8%';
  vuNum.textContent = '-∞ dB';
}

/* ========= CONSTRAINTS ========= */
function buildAudioConstraints(){
  const deviceId = micSelect.value || undefined;
  const base = {
    echoCancellation: false,
    noiseSuppression: false,
    autoGainControl: false,
    channelCount: 1,
    sampleRate: 48000,
    sampleSize: 16,
    latency: 0
  };
  const c = deviceId ? { deviceId: { exact: deviceId }, ...base } : base;
  return { audio: c };
}
function logSupportedConstraints(){
  try{
    const sc = navigator.mediaDevices.getSupportedConstraints?.() || {};
    log('Supported constraints: ' + (Object.keys(sc).filter(k=>sc[k]).join(', ') || '(brak)'));
  }catch(_){}
}

/* ========= NAGRYWANIE ========= */
let liveStream = null;

$('btnStart').onclick = async ()=>{
  try{
    if (liveStream) { try { liveStream.getTracks().forEach(t=>t.stop()); } catch(_){} liveStream = null; }

    const constraints = buildAudioConstraints();
    logSupportedConstraints();
    log('Proszę o mikrofon (surowy tor)…');
    const micStream = await navigator.mediaDevices.getUserMedia(constraints);
    liveStream = micStream;

    try{
      const track = micStream.getAudioTracks?.()[0];
      if (track){
        const s = track.getSettings?.() || {};
        log('Ustawienia wejścia: ' + JSON.stringify({
          deviceId: s.deviceId, channelCount: s.channelCount,
          sampleRate: s.sampleRate, sampleSize: s.sampleSize,
          echoCancellation: s.echoCancellation, noiseSuppression: s.noiseSuppression, autoGainControl: s.autoGainControl
        }));
      }
    }catch(_){}

    chunks = []; recordedBlob = null; durationMs = 0; startedAt = Date.now();

    const recOpts = { mimeType, audioBitsPerSecond: 128000 };
    mediaRecorder = new MediaRecorder(micStream, recOpts);

    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      durationMs = Date.now() - startedAt;
      recordedBlob = new Blob(chunks, {type:mimeType});
      player.src = URL.createObjectURL(recordedBlob);

      const i = sanitize(student.imie), n = sanitize(student.nazwisko), t = sanitize(student.tytul);
      fileName = `SPM-${ts()}-${i||'imie'}-${n||'nazw'}-${t||'tytul'}.webm`;

      $('btnDownload').disabled = false;
      $('btnSendAll').disabled  = false;
      $('btnAudition').disabled = false;
      $('btnStopAud').disabled  = true;

      const kbps = durationMs>0 ? Math.round((recordedBlob.size * 8) / (durationMs/1000) / 1000) : 0;
      log(`Nagranie gotowe. Czas ~ ${durationMs} ms; rozmiar ~ ${Math.round(recordedBlob.size/1024)} KB; bitrate ~ ${kbps} kbps`);
      if (kbps < 48) log('Uwaga: niski bitrate – możliwe artefakty mowy. Rozważ wyższy audioBitsPerSecond lub inną przeglądarkę.');

      setBanner('Gotowe nagranie. Możesz odsłuchać, pobrać wokal albo „Wyślij”.');
      stepActive('step2');
      stopVU();
    };

    // VU start
    startVU(micStream);

    backing.addEventListener('ended', onBackingEndedDuringRec);
    isRecording = true;

    try { if (backing.src) { backing.currentTime = 0; await backing.play(); } } catch(e) { log('Uwaga: podkład nie wystartował ('+e.message+').'); }
    mediaRecorder.start();

    startMaxTimers();

    $('btnStart').disabled = true;
    $('btnStop').disabled = false;
    setBanner('Nagrywanie… Po zakończeniu podkładu nagranie zatrzyma się automatycznie.');
  }catch(e){
    alert('Brak lub zablokowany dostęp do mikrofonu.'); log('BŁĄD mikrofon: '+e.message);
    stopVU();
  }
};

$('btnStop').onclick = ()=> stopRecording('manual');

function stopRecording(reason='manual'){
  try{
    clearMaxTimers();
    if (isRecording && mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
  }catch(_){}

  isRecording = false;
  try { backing.pause(); } catch(_){}
  $('btnStart').disabled = false;
  $('btnStop').disabled = true;
  stopVU();

  if (reason === 'auto-end') {
    setBanner('Nagranie zakończone automatycznie z końcem podkładu. Możesz „Wyślij” albo „Pobierz wokal”.');
    log('Auto-Stop: koniec podkładu.');
  } else if (reason === 'max-limit') {
    setBanner('Nagranie zatrzymane (limit 7 min). Jeśli to błąd, skróć nagranie.');
    log('Auto-Stop: limit 7 min.');
  }
}

function onBackingEndedDuringRec(){
  if (isRecording) stopRecording('auto-end');
}

/* ========= ODSŁUCH ========= */
$('offsetMs').addEventListener('input', e=>{
  offsetMs = parseInt(e.target.value,10)||0;
  $('offsetVal').textContent = `${offsetMs} ms`;
  if (!player.paused) resyncBackingToPlayer();
});
$('tempoPct').addEventListener('input', e=>{
  tempoPct = parseFloat(e.target.value)||0;
  $('tempoVal').textContent = `${tempoPct.toFixed(2)}%`;
  backing.playbackRate = 1 + (tempoPct/100);
});

$('btnAudition').onclick = ()=>{
  if (!recordedBlob || !backing.src) { alert('Brak nagrania lub podkładu.'); return; }
  resyncBackingToPlayer();
  safePlay(backing); safePlay(player);
  setAuditionButtons(true); isAuditioning = true;
  startAutoResync();
};
$('btnStopAud').onclick = ()=> stopAudition();

player.addEventListener('ended', ()=> stopAudition());
backing.addEventListener('ended', ()=> { if (!isRecording) stopAudition(); });
player.addEventListener('pause', ()=> { if (!backing.paused) backing.pause(); stopAutoResync(); });

function stopAudition(){
  try{ player.pause(); }catch(_){}
  try{ backing.pause(); }catch(_){}
  stopAutoResync();
  setAuditionButtons(false); isAuditioning = false;
}
function setAuditionButtons(running){
  $('btnAudition').disabled = running;
  $('btnStopAud').disabled  = !running;
}
function startAutoResync(){
  stopAutoResync();
  resyncTimer = setInterval(()=>{
    const pd = isFinite(player.duration) ? player.duration : 0;
    const bd = isFinite(backing.duration) ? backing.duration : 0;
    if ((pd && player.currentTime >= pd - 0.05) || (bd && backing.currentTime >= bd - 0.05)) {
      stopAudition(); return;
    }
    const target = player.currentTime + offsetMs/1000;
    const diff = Math.abs((backing.currentTime||0) - target);
    if (diff > 0.12) backing.currentTime = Math.max(0, target);
  }, 400);
}
function stopAutoResync(){ if (resyncTimer){ clearInterval(resyncTimer); resyncTimer=null; } }
function resyncBackingToPlayer(){
  const target = player.currentTime + offsetMs/1000;
  backing.currentTime = Math.max(0, target);
  backing.playbackRate = 1 + (tempoPct/100);
}
function safePlay(elm){ elm.play().catch(()=>{}); }

/* ========= BEZPIECZNIKI CZASU ========= */
function startMaxTimers(){
  clearMaxTimers();
  warnTimer = setTimeout(()=>{
    if (isRecording) {
      setBanner('Za ~30 sekund nagranie zatrzyma się (limit 7 min).');
      log('Ostrzeżenie: zbliża się limit 7 min.');
    }
  }, Math.max(0, MAX_MS - WARN_BEFORE_MS));
  maxTimer = setTimeout(()=>{
    if (isRecording) stopRecording('max-limit');
  }, MAX_MS);
}
function clearMaxTimers(){
  if (warnTimer){ clearTimeout(warnTimer); warnTimer=null; }
  if (maxTimer){ clearTimeout(maxTimer); maxTimer=null; }
}

/* ========= WYSYŁKA ========= */
$('btnDownload').onclick = ()=>{
  if(!recordedBlob) return;
  const a=document.createElement('a'); a.href=URL.createObjectURL(recordedBlob); a.download=fileName; a.click();
};

$('btnSendAll').onclick = async ()=>{
  if(!recordedBlob){ alert('Najpierw nagraj.'); return; }
  try{
    const sendBtn = $('btnSendAll');
    sendBtn.textContent = 'Wysyłam…';
    sendBtn.classList.add('blink');
    sendBtn.disabled = true;

    log('Konwersja na base64…');
    const base64 = await blobToBase64(recordedBlob);

    log('Wysyłanie na Drive…');
    const up = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'upload', fileBase64: base64, mimeType, fileName })
    }).then(r=>r.json());
    if(!up.ok) throw new Error(up.error || 'Upload failed');

    $('fileIdSpan').textContent = up.fileId; $('fileIdLine').hidden = true;
    log(`Upload OK, fileId: ${up.fileId}`);

    metaToSend = {
      ver: 1, ts: Date.now(),
      imie: student.imie, nazwisko: student.nazwisko, email: student.email,
      miejscowosc: student.miejscowosc, tytul: student.tytul,
      trackUrl: student.trackUrl,
      durationMs,
      fileId: up.fileId, viewLink: up.viewLink, downloadLink: up.downloadLink,
      fileName, mimeType
    };

    log('Zapis do Sheets…');
    const m = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'meta', meta: metaToSend })
    }).then(r=>r.json());
    if(!m.ok) throw new Error(m.error || 'Sheets error');
    log('Sheets: OK (wiersz '+m.row+')');

    if (PARENT_URL) {
      const spmParam = encodeURIComponent(JSON.stringify(metaToSend));
      $('aReturn').href = PARENT_URL + (PARENT_URL.includes('?') ? '&' : '?') + 'spm=' + spmParam;
      $('aReturn').style.display = 'inline-flex';
    }

    setBanner('Wysłano. Kliknij:  ➜  „Wróć do SPM – Potwierdź wysyłkę i Zapisz”.');
    stepActive('step2');

    sendBtn.classList.remove('blink');
    sendBtn.textContent = 'Wyślij';
    sendBtn.disabled = false;

  }catch(e){
    $('btnSendAll').classList.remove('blink');
    $('btnSendAll').textContent = 'Wyślij';
    $('btnSendAll').disabled = false;
    log('BŁĄD: '+(e.message||e));
    alert('Nie udało się dokończyć wysyłki: '+(e.message||e));
  }
};
</script>
</body>
</html>
