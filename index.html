<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM ‚Äì nagrywanie</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#111; color:#eee; }
    h1,h2{ margin: 0 0 12px 0; }
    h2{ margin-top: 22px; }
    input[type="range"]{ width: 260px; }
    button{ padding:10px 14px; border-radius:8px; border:0; background:#2e7d32; color:#fff; cursor:pointer; }
    button.secondary{ background:#444; }
    button.warn{ background:#1565c0; }
    button.danger{ background:#8e1b1b; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    a.inline { display:inline-block; margin:6px 8px 0 0; }
    .card{ border:1px solid #272727; border-radius:12px; padding:16px; margin:18px 0; background:#141414; }
    #log{ background:#0c0c0c; border:1px solid #222; border-radius:12px; padding:12px; white-space:pre-wrap; min-height:120px; }
    .note{ opacity:.85; font-size:.92rem; }
    .val{ display:inline-block; min-width:70px; text-align:right; opacity:.9; }
    .inline-controls{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .hidden-audio { display:none; }
    .progress-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .progress-row label{ min-width:120px; opacity:.9; }
    .progress-row input[type="range"]{ width: 360px; }
    .time{ font-variant-tabular-nums: tabular-nums; opacity:.9; min-width:80px; text-align:right; }

    /* baner u g√≥ry */
    #banner {
      position: sticky; top: -8px; z-index: 5;
      background: #0b0b0b; border:1px solid #333; padding:10px 12px;
      border-radius:10px; margin-bottom:14px; text-align:center;
      color:#eaeaea;
    }
    /* ‚ÄûCzekaj‚Ä¶‚Äù ‚Äì miganie */
    @keyframes blink { 50% { opacity:.35 } }
    .blink { animation: blink 0.9s linear infinite; }
  </style>
</head>
<body>
  <div id="banner"></div>

  <h1>SPM ‚Äì nagrywanie</h1>

  <!-- 1) Podk≈Çad (ods≈Çuch) -->
  <h2>Podk≈Çad (ods≈Çuch)</h2>
  <div class="card">
    <div class="inline-controls" style="margin-top:8px">
      <label for="trackVol">G≈Ço≈õno≈õƒá podk≈Çadu</label>
      <input id="trackVol" type="range" min="0" max="1" step="0.01" value="0.7" />
      <span id="trackVolVal" class="val">70%</span>
    </div>

    <div class="progress-row">
      <label for="backingSeek">Postƒôp podk≈Çadu</label>
      <input id="backingSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="backingTime" class="time">0:00 / 0:00</span>
    </div>

    <audio id="backing" preload="auto" class="hidden-audio"></audio>
    <div class="note">Podk≈Çad gra w s≈Çuchawkach podczas nagrania. <b>Nie zapisuje siƒô</b> w pliku ‚Äî nagrywa siƒô tylko mikrofon.</div>
  </div>

  <!-- 2) Nagrywanie -->
  <h2>Nagrywanie</h2>
  <div class="card">
    <div class="inline-controls">
      <button id="btnStart">Start</button>
      <button id="btnStop" class="secondary" disabled>Stop</button>
      <button id="btnDownload" class="secondary" disabled>Pobierz</button>
    </div>

    <div class="progress-row">
      <label for="playerSeek">Postƒôp nagrania</label>
      <input id="playerSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="playerTime" class="time">0:00 / 0:00</span>
    </div>

    <audio id="player" class="hidden-audio"></audio>

    <div style="margin-top:14px" class="inline-controls">
      <button id="btnAudition" class="warn" disabled>Ods≈Çuchaj (z podk≈Çadem)</button>
      <button id="btnStopAud" class="danger" disabled>Zatrzymaj ods≈Çuch</button>

      <label for="offsetMs">Korekta przesuniƒôcia</label>
      <input id="offsetMs" type="range" min="-800" max="800" step="10" value="0" />
      <span id="offsetVal" class="val">0 ms</span>

      <label for="tempoPct">Korekta tempa</label>
      <input id="tempoPct" type="range" min="-1" max="1" step="0.05" value="0" />
      <span id="tempoVal" class="val">0.00%</span>
    </div>

    <div class="note">Je≈õli czujesz ‚Äûrozjazd‚Äù, u≈ºyj suwak√≥w: <b>przesuniƒôcie</b> (ms) i <b>tempo</b> (¬±1%) ‚Äî dzia≈Ça tylko w ods≈Çuchu.</div>
  </div>

  <!-- 3) Wysy≈Çka -->
  <h2>Wy≈õlij</h2>
  <div class="card">
    <div class="inline-controls">
      <button id="btnSendAll" class="warn" disabled>Wy≈õlij</button>
      <button id="btnConfirmSend" class="secondary" style="display:none">Potwierd≈∫ wysy≈Çkƒô</button>
    </div>
    <div style="margin-top:10px">
      <a id="aView" class="inline" href="#" target="_blank" rel="noopener" hidden>üîé PodglƒÖd (Drive)</a>
      <a id="aDl" class="inline" href="#" target="_blank" rel="noopener" hidden>‚¨áÔ∏è Pobierz (direct)</a>
      <div id="fileIdLine" class="note" hidden>fileId: <span id="fileIdSpan"></span></div>
    </div>
  </div>

  <!-- Log -->
  <h2>Log</h2>
  <pre id="log"></pre>

<script>
/* ========= KONFIG ========= */
const FN_URL = '/.netlify/functions/spm';
const PARENT_PARAM = new URLSearchParams(location.search).get('parent') || '';
let PARENT_ORIGIN = '*';
try { PARENT_ORIGIN = new URL(PARENT_PARAM).origin || '*'; } catch(_) {}

/* ========= STAN ========= */
let mediaRecorder, chunks = [], recordedBlob = null, startedAt = 0, durationMs = 0;
let fileName = '', mimeType = 'audio/webm';
let metaToSend = null;   // <- meta do wys≈Çania po ‚ÄûPotwierd≈∫ wysy≈Çkƒô‚Äù

const el = id => document.getElementById(id);
const backing = el('backing');
const player  = el('player');
const backingSeek = el('backingSeek');
const playerSeek  = el('playerSeek');
const backingTime = el('backingTime');
const playerTime  = el('playerTime');
const banner = el('banner');

let offsetMs = 0, tempoPct = 0, resyncTimer = null, rafId = null, isAuditioning = false;

/* ========= UTIL ========= */
function log(m){ el('log').textContent += m + '\n'; }
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
function sanitize(s){ return (s||'').trim().replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,''); }
function blobToBase64(blob){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(blob); }); }
function parseQ(){ try{ const q=new URLSearchParams(location.search).get('q'); return q?JSON.parse(decodeURIComponent(q)) : {}; }catch(_){ return {}; } }
function fmt(t){ if(!isFinite(t)||t<0) t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${String(s).padStart(2,'0')}`; }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
function setBanner(text){ banner.textContent = text || ''; }

/* ========= PREFILL ========= */
let student = { imie:'', nazwisko:'', email:'', miejscowosc:'', tytul:'', trackUrl:'' };
(function init(){
  const q = parseQ();
  student = {
    imie: q.imie || '', nazwisko: q.nazwisko || '', email: q.email || '',
    miejscowosc: q.miejscowosc || '', tytul: q.tytul || '', trackUrl: q.trackUrl || ''
  };
  if (student.trackUrl) { backing.src = student.trackUrl; backing.load(); log('Podk≈Çad ustawiony z WIX (#podkladUrl).'); }
  setBanner('');
})();

/* ========= PROGRESS ========= */
function refreshProgress(){
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bc = isFinite(backing.currentTime) ? backing.currentTime : 0;
  backingSeek.max = bd || 0;
  if (document.activeElement !== backingSeek) backingSeek.value = bc;
  backingTime.textContent = `${fmt(bc)} / ${fmt(bd)}`;

  const pd = isFinite(player.duration) ? player.duration : (durationMs? durationMs/1000 : 0);
  const pc = isFinite(player.currentTime) ? player.currentTime : 0;
  playerSeek.max = pd || 0;
  if (document.activeElement !== playerSeek) playerSeek.value = pc;
  playerTime.textContent = `${fmt(pc)} / ${fmt(pd)}`;

  rafId = requestAnimationFrame(refreshProgress);
}
rafId = requestAnimationFrame(refreshProgress);

playerSeek.addEventListener('input', ()=>{
  const pd = isFinite(player.duration) ? player.duration : 0;
  const t = clamp(parseFloat(playerSeek.value)||0, 0, pd||1e9);
  player.currentTime = t;
  if (isAuditioning) resyncBackingToPlayer();
});
backingSeek.addEventListener('input', ()=>{
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bt = clamp(parseFloat(backingSeek.value)||0, 0, bd||1e9);
  const targetPlayer = clamp(bt - offsetMs/1000, 0, (isFinite(player.duration)?player.duration:1e9));
  player.currentTime = targetPlayer;
  if (isAuditioning) resyncBackingToPlayer();
});

/* ========= PODK≈ÅAD ========= */
el('trackVol').addEventListener('input', e=>{
  const v = parseFloat(e.target.value||'0.7'); backing.volume = v; el('trackVolVal').textContent = Math.round(v*100)+'%';
});
backing.volume = parseFloat(el('trackVol').value||'0.7');
backing.preservesPitch = true; backing.mozPreservesPitch = true; backing.webkitPreservesPitch = true;

/* ========= NAGRYWANIE ========= */
el('btnStart').onclick = async ()=>{
  try{
    const micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = []; recordedBlob = null; durationMs = 0; startedAt = Date.now();

    mediaRecorder = new MediaRecorder(micStream, {mimeType});
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      durationMs = Date.now() - startedAt;
      recordedBlob = new Blob(chunks, {type:mimeType});
      player.src = URL.createObjectURL(recordedBlob);

      const i = sanitize(student.imie), n = sanitize(student.nazwisko), t = sanitize(student.tytul);
      fileName = `SPM-${ts()}-${i||'imie'}-${n||'nazw'}-${t||'tytul'}.webm`;

      el('btnDownload').disabled = false;
      el('btnSendAll').disabled  = false;
      el('btnAudition').disabled = false;
      el('btnStopAud').disabled  = true;

      log(`Nagranie gotowe. Czas ~ ${durationMs} ms; rozmiar ~ ${Math.round(recordedBlob.size/1024)} KB`);
    };

    try { if (backing.src) { backing.currentTime = 0; await backing.play(); } } catch(e) { log('Uwaga: podk≈Çad nie wystartowa≈Ç ('+e.message+').'); }
    mediaRecorder.start();

    el('btnStart').disabled = true;
    el('btnStop').disabled = false;
    log('Nagrywanie‚Ä¶ (podk≈Çad tylko w s≈Çuchawkach)');
  }catch(e){
    alert('Brak dostƒôpu do mikrofonu.'); log('B≈ÅƒÑD mikrofon: '+e.message);
  }
};

el('btnStop').onclick = ()=>{
  if(mediaRecorder && mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    el('btnStart').disabled = false;
    el('btnStop').disabled = true;
    try{ backing.pause(); }catch(_){}
  }
};

el('btnDownload').onclick = ()=>{
  if(!recordedBlob) return;
  const a=document.createElement('a'); a.href=URL.createObjectURL(recordedBlob); a.download=fileName; a.click();
};

/* ========= ODS≈ÅUCH ========= */
el('offsetMs').addEventListener('input', e=>{
  offsetMs = parseInt(e.target.value,10)||0;
  el('offsetVal').textContent = `${offsetMs} ms`;
  if (!player.paused) resyncBackingToPlayer();
});
el('tempoPct').addEventListener('input', e=>{
  tempoPct = parseFloat(e.target.value)||0;
  el('tempoVal').textContent = `${tempoPct.toFixed(2)}%`;
  backing.playbackRate = 1 + (tempoPct/100);
});

el('btnAudition').onclick = ()=>{
  if (!recordedBlob || !backing.src) { alert('Brak nagrania lub podk≈Çadu.'); return; }
  resyncBackingToPlayer();
  safePlay(backing); safePlay(player);
  setAuditionButtons(true); isAuditioning = true;
  startAutoResync();
};
el('btnStopAud').onclick = ()=> stopAudition();

player.addEventListener('ended', ()=> stopAudition());
backing.addEventListener('ended', ()=> stopAudition());
player.addEventListener('pause', ()=> { if (!backing.paused) backing.pause(); stopAutoResync(); });

function stopAudition(){
  try{ player.pause(); }catch(_){}
  try{ backing.pause(); }catch(_){}
  stopAutoResync();
  setAuditionButtons(false); isAuditioning = false;
}
function setAuditionButtons(running){
  el('btnAudition').disabled = running;
  el('btnStopAud').disabled  = !running;
}
function startAutoResync(){
  stopAutoResync();
  resyncTimer = setInterval(()=>{
    const pd = isFinite(player.duration) ? player.duration : 0;
    const bd = isFinite(backing.duration) ? backing.duration : 0;
    if ((pd && player.currentTime >= pd - 0.05) || (bd && backing.currentTime >= bd - 0.05)) {
      stopAudition(); return;
    }
    const target = player.currentTime + offsetMs/1000;
    const diff = Math.abs((backing.currentTime||0) - target);
    if (diff > 0.12) backing.currentTime = Math.max(0, target);
  }, 400);
}
function stopAutoResync(){ if (resyncTimer){ clearInterval(resyncTimer); resyncTimer=null; } }
function resyncBackingToPlayer(){
  const target = player.currentTime + offsetMs/1000;
  backing.currentTime = Math.max(0, target);
  backing.playbackRate = 1 + (tempoPct/100);
}
function safePlay(elm){ elm.play().catch(()=>{}); }

/* ========= WYSY≈ÅKA (manualny fina≈Ç) ========= */
el('btnSendAll').onclick = async ()=>{
  if(!recordedBlob){ alert('Najpierw nagraj.'); return; }
  try{
    // ‚ÄûCzekaj‚Ä¶‚Äù
    const sendBtn = el('btnSendAll');
    sendBtn.textContent = 'Czekaj‚Ä¶';
    sendBtn.classList.add('blink');
    sendBtn.disabled = true;

    log('Konwersja na base64‚Ä¶');
    const base64 = await blobToBase64(recordedBlob);

    log('Wysy≈Çanie na Drive‚Ä¶');
    const r1 = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'upload', fileBase64: base64, mimeType, fileName })
    });
    const up = await r1.json();
    if(!up.ok) throw new Error(up.error || 'Upload failed');

    el('aView').href = up.viewLink; el('aView').hidden = false;
    el('aDl').href   = up.downloadLink; el('aDl').hidden = false;
    el('fileIdSpan').textContent = up.fileId; el('fileIdLine').hidden = false;
    log(`Upload OK, fileId: ${up.fileId}`);

    // meta do p√≥≈∫niejszego ‚ÄûPotwierd≈∫ wysy≈Çkƒô‚Äù
    metaToSend = {
      ver: 1, ts: Date.now(),
      imie: student.imie, nazwisko: student.nazwisko, email: student.email,
      miejscowosc: student.miejscowosc, tytul: student.tytul,
      durationMs, fileId: up.fileId, viewLink: up.viewLink, downloadLink: up.downloadLink,
      fileName, mimeType
    };

    log('Zapis do Sheets‚Ä¶');
    const r2 = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'meta', meta: metaToSend })
    });
    const m = await r2.json();
    if(!m.ok) throw new Error(m.error || 'Sheets error');
    log('Sheets: OK (wiersz '+m.row+')');

    // poka≈º przycisk ‚ÄûPotwierd≈∫ wysy≈Çkƒô‚Äù, baner z instrukcjƒÖ
    el('btnConfirmSend').style.display = '';
    el('btnConfirmSend').disabled = false;
    setBanner('Wys≈Çano. Zamknij tƒô kartƒô i wr√≥ƒá do strony SPM ‚Äì lub kliknij ‚ÄûPotwierd≈∫ wysy≈Çkƒô‚Äù.');

    // zatrzymaj miganie na Wy≈õlij
    sendBtn.classList.remove('blink');
    sendBtn.textContent = 'Wy≈õlij';

  }catch(e){
    el('btnSendAll').classList.remove('blink');
    el('btnSendAll').textContent = 'Wy≈õlij';
    el('btnSendAll').disabled = false;
    log('B≈ÅƒÑD: '+(e.message||e));
    alert('Nie uda≈Ço siƒô doko≈Ñczyƒá wysy≈Çki: '+(e.message||e));
  }
};

el('btnConfirmSend').onclick = ()=>{
  if (!metaToSend){
    alert('Brak danych do potwierdzenia.'); return;
  }
  // wy≈õlij do SPM
  try{
    if (window.opener){
      window.opener.postMessage({ type:'spmUpload', payload: metaToSend }, PARENT_ORIGIN);
    }
  }catch(_){}

  // komunikat + pr√≥ba zamkniƒôcia
  setBanner('Potwierdzono. Je≈õli okno siƒô nie zamknie, zamknij je rƒôcznie.');
  try{ window.close(); }catch(_){}
};
</script>
</body>
</html>
