<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM – Studio nagrań</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; background:#0f0f0f; color:#f1f1f1; }
    h1{ margin: 0 0 14px 0; font-size: 1.6rem; }
    h2{ margin: 18px 0 10px; font-size: 1.2rem; }
    .section{ border:1px solid #262626; border-radius:12px; padding:14px; margin:14px 0; background:#141414; }
    .row{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .stack-sm{ display:flex; gap:10px; flex-wrap:wrap; align-items:stretch; }
    .stack-sm > * { flex: 0 0 auto; }
    @media (max-width:640px){
      .row{ flex-direction:column; align-items:flex-start; }
      .stack-sm{ flex-direction:column; }
    }

    input[type="range"]{ width: min(420px, 90vw); }
    .val, .time{ font-variant-numeric: tabular-nums; opacity:.9; }
    .time{ min-width:92px; text-align:right; }

    /* przyciski – ten sam styl dla <button> i <a> */
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:10px; border:0; background:#2e7d32; color:#fff;
      text-decoration:none; cursor:pointer; font-weight:600; box-shadow:0 0 0 0 rgba(0,0,0,0);
      transition: transform .04s ease, box-shadow .2s ease, opacity .2s ease;
    }
    .btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.25); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{ background:#3d3d3d; color:#f2f2f2; }
    .btn.warn{ background:#1565c0; }
    .btn.danger{ background:#8e1b1b; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; box-shadow:none; }

    .note{ opacity:.85; font-size:.92rem; }

    /* baner-instrukcja */
    #banner { border:1px solid #2a2a2a; padding:10px 12px; border-radius:10px; margin-bottom:12px; text-align:center; color:#eaeaea; background:#121212; }
    @keyframes blink { 50% { opacity:.38 } }
    .blink { animation: blink .9s linear infinite; }

    /* Log kompaktowy */
    #log{ background:#0b0b0b; border:1px solid #202020; border-radius:12px; padding:12px; white-space:pre-wrap; }
    .log-wrap{ max-height:260px; overflow:auto; }

    /* kroki – delikatne prowadzenie */
    .step { position:relative; }
    .step::before{
      content: attr(data-step);
      position:absolute; left:-10px; top:-10px;
      background:#1e1e1e; border:1px solid #2a2a2a; color:#cfcfcf;
      padding:2px 8px; border-radius:999px; font-size:.78rem;
    }
    .step.active{ outline:2px solid #1e5e1f; outline-offset: 2px; }
  </style>
</head>
<body>
  <div id="banner">1) Wybierz podkład w SPM → 2) Nagraj → 3) Wyślij → 4) <b>Wróć do SPM – Potwierdź wysyłkę i Zapisz</b></div>

  <h1>SPM – Studio nagrań</h1>

  <!-- 1) Podkład (odsłuch) -->
  <div class="section step" id="step1" data-step="Krok 1">
    <h2>Podkład (odsłuch)</h2>
    <div class="row" style="margin-top:6px">
      <label for="trackVol">Głośność podkładu</label>
      <input id="trackVol" type="range" min="0" max="1" step="0.01" value="0.7" />
      <span id="trackVolVal" class="val">70%</span>
    </div>

    <div class="row" style="margin-top:8px">
      <label for="backingSeek">Postęp podkładu</label>
      <input id="backingSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="backingTime" class="time">0:00 / 0:00</span>
    </div>

    <audio id="backing" preload="auto" style="display:none"></audio>
    <div class="note">Podkład gra w słuchawkach podczas nagrywania. <b>Nie zapisuje się</b> w pliku — nagrywa się tylko mikrofon.</div>
  </div>

  <!-- 2) Nagrywanie -->
  <div class="section step" id="step2" data-step="Krok 2">
    <h2>Nagrywanie</h2>

    <div class="stack-sm" style="margin:6px 0 4px">
      <button id="btnStart" class="btn">Start</button>
      <button id="btnStop" class="btn secondary" disabled>Stop</button>
      <button id="btnDownload" class="btn secondary" disabled>Pobierz wokal</button>
    </div>

    <div class="row" style="margin-top:6px">
      <label for="playerSeek">Postęp nagrania</label>
      <input id="playerSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="playerTime" class="time">0:00 / 0:00</span>
    </div>

    <audio id="player" style="display:none"></audio>

    <div class="stack-sm" style="margin-top:10px">
      <button id="btnAudition" class="btn warn" disabled>Odsłuchaj (z podkładem)</button>
      <button id="btnStopAud" class="btn danger" disabled>Zatrzymaj odsłuch</button>

      <div class="row">
        <label for="offsetMs">Korekta przesunięcia</label>
        <input id="offsetMs" type="range" min="-800" max="800" step="10" value="0" />
        <span id="offsetVal" class="val">0 ms</span>
      </div>

      <div class="row">
        <label for="tempoPct">Korekta tempa</label>
        <input id="tempoPct" type="range" min="-1" max="1" step="0.05" value="0" />
        <span id="tempoVal" class="val">0.00%</span>
      </div>
    </div>

    <div class="note">Jeśli czujesz „rozjazd”, użyj suwaków: <b>przesunięcie</b> (ms) i <b>tempo</b> (±1%) — działa tylko w odsłuchu.</div>
  </div>

  <!-- 3) Wyślij -->
  <div class="section step" id="step3" data-step="Krok 3">
    <h2>Wyślij</h2>
    <div class="stack-sm" style="margin:6px 0 8px">
      <button id="btnSendAll" class="btn warn" disabled>Wyślij</button>

      <!-- Link-przycisk: zostawiamy <a>, zero zamykania okna -->
      <a id="aReturn" class="btn" href="#" style="display:none">Wróć do SPM – Potwierdź wysyłkę i Zapisz</a>
    </div>

    <!-- Linia z fileId (zostawiamy, ale nie pokazujemy użytkownikom) -->
    <div id="fileIdLine" class="note" hidden>fileId: <span id="fileIdSpan"></span></div>
  </div>

  <!-- 4) Log -->
  <div class="section step" id="step4" data-step="Podgląd">
    <h2>Log</h2>
    <div class="log-wrap"><pre id="log"></pre></div>
  </div>

<script>
/* ========= KONFIG ========= */
const FN_URL = '/.netlify/functions/spm';
const qs            = new URLSearchParams(location.search);
const parentUrlRaw  = qs.get('parent') || '';
const PARENT_ORIGIN = parentUrlRaw ? new URL(parentUrlRaw).origin : '*';
const PARENT_URL    = parentUrlRaw || ''; // do linku „Wróć do SPM…”

/* ========= STAN ========= */
let mediaRecorder, chunks = [], recordedBlob = null, startedAt = 0, durationMs = 0;
let fileName = '', mimeType = 'audio/webm';
let metaToSend = null;

const $ = id => document.getElementById(id);
const backing = $('backing');
const player  = $('player');
const backingSeek = $('backingSeek');
const playerSeek  = $('playerSeek');
const backingTime = $('backingTime');
const playerTime  = $('playerTime');
const banner = $('banner');

let offsetMs = 0, tempoPct = 0, resyncTimer = null, rafId = null, isAuditioning = false;

/* ========= UTIL ========= */
function log(m){ $('log').textContent += m + '\n'; }
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
function sanitize(s){ return (s||'').trim().replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,''); }
function blobToBase64(blob){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(blob); }); }
function parseQ(){ try{ const q=new URLSearchParams(location.search).get('q'); return q?JSON.parse(decodeURIComponent(q)) : {}; }catch(_){ return {}; } }
function fmt(t){ if(!isFinite(t)||t<0) t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${String(s).padStart(2,'0')}`; }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }
function setBanner(text){ banner.textContent = text || ''; }
function stepActive(id){ try{ document.querySelectorAll('.step').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }catch(_){} }

/* ========= PREFILL ========= */
let student = { imie:'', nazwisko:'', email:'', miejscowosc:'', tytul:'', trackUrl:'' };
(function init(){
  const q = parseQ();
  student = {
    imie: q.imie || '', nazwisko: q.nazwisko || '', email: q.email || '',
    miejscowosc: q.miejscowosc || '', tytul: q.tytul || '', trackUrl: q.trackUrl || ''
  };
  if (student.trackUrl) { backing.src = student.trackUrl; backing.load(); log('Podkład ustawiony (z SPM).'); }
  setBanner('1) Wybierz podkład w SPM → 2) Nagraj → 3) Wyślij → 4) Wróć do SPM – Potwierdź wysyłkę i Zapisz');
  stepActive('step2');
})();

/* ========= PROGRESS ========= */
function refreshProgress(){
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bc = isFinite(backing.currentTime) ? backing.currentTime : 0;
  backingSeek.max = bd || 0;
  if (document.activeElement !== backingSeek) backingSeek.value = bc;
  backingTime.textContent = `${fmt(bc)} / ${fmt(bd)}`;

  const pd = isFinite(player.duration) ? player.duration : (durationMs? durationMs/1000 : 0);
  const pc = isFinite(player.currentTime) ? player.currentTime : 0;
  playerSeek.max = pd || 0;
  if (document.activeElement !== playerSeek) playerSeek.value = pc;
  playerTime.textContent = `${fmt(pc)} / ${fmt(pd)}`;

  rafId = requestAnimationFrame(refreshProgress);
}
rafId = requestAnimationFrame(refreshProgress);

playerSeek.addEventListener('input', ()=>{
  const pd = isFinite(player.duration) ? player.duration : 0;
  const t = clamp(parseFloat(playerSeek.value)||0, 0, pd||1e9);
  player.currentTime = t;
  if (isAuditioning) resyncBackingToPlayer();
});
backingSeek.addEventListener('input', ()=>{
  const bd = isFinite(backing.duration) ? backing.duration : 0;
  const bt = clamp(parseFloat(backingSeek.value)||0, 0, bd||1e9);
  const targetPlayer = clamp(bt - offsetMs/1000, 0, (isFinite(player.duration)?player.duration:1e9));
  player.currentTime = targetPlayer;
  if (isAuditioning) resyncBackingToPlayer();
});

/* ========= PODKŁAD ========= */
$('trackVol').addEventListener('input', e=>{
  const v = parseFloat(e.target.value||'0.7'); backing.volume = v; $('trackVolVal').textContent = Math.round(v*100)+'%';
});
backing.volume = parseFloat($('trackVol').value||'0.7');
backing.preservesPitch = true; backing.mozPreservesPitch = true; backing.webkitPreservesPitch = true;

/* ========= NAGRYWANIE ========= */
$('btnStart').onclick = async ()=>{
  try{
    const micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = []; recordedBlob = null; durationMs = 0; startedAt = Date.now();

    mediaRecorder = new MediaRecorder(micStream, {mimeType});
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      durationMs = Date.now() - startedAt;
      recordedBlob = new Blob(chunks, {type:mimeType});
      player.src = URL.createObjectURL(recordedBlob);

      const i = sanitize(student.imie), n = sanitize(student.nazwisko), t = sanitize(student.tytul);
      fileName = `SPM-${ts()}-${i||'imie'}-${n||'nazw'}-${t||'tytul'}.webm`;

      $('btnDownload').disabled = false;
      $('btnSendAll').disabled  = false;
      $('btnAudition').disabled = false;
      $('btnStopAud').disabled  = true;

      setBanner('Gotowe nagranie. Możesz odsłuchać, pobrać wokal albo od razu „Wyślij”.');
      stepActive('step3');
      log(`Nagranie gotowe. Czas ~ ${durationMs} ms; rozmiar ~ ${Math.round(recordedBlob.size/1024)} KB`);
    };

    try { if (backing.src) { backing.currentTime = 0; await backing.play(); } } catch(e) { log('Uwaga: podkład nie wystartował ('+e.message+').'); }
    mediaRecorder.start();

    $('btnStart').disabled = true;
    $('btnStop').disabled = false;
    setBanner('Nagrywanie… (podkład tylko w słuchawkach). Po zakończeniu kliknij „Stop”.');
  }catch(e){
    alert('Brak dostępu do mikrofonu.'); log('BŁĄD mikrofon: '+e.message);
  }
};

$('btnStop').onclick = ()=>{
  if(mediaRecorder && mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    $('btnStart').disabled = false;
    $('btnStop').disabled = true;
    try{ backing.pause(); }catch(_){}
  }
};

$('btnDownload').onclick = ()=>{
  if(!recordedBlob) return;
  const a=document.createElement('a'); a.href=URL.createObjectURL(recordedBlob); a.download=fileName; a.click();
};

/* ========= ODSŁUCH ========= */
$('offsetMs').addEventListener('input', e=>{
  offsetMs = parseInt(e.target.value,10)||0;
  $('offsetVal').textContent = `${offsetMs} ms`;
  if (!player.paused) resyncBackingToPlayer();
});
$('tempoPct').addEventListener('input', e=>{
  tempoPct = parseFloat(e.target.value)||0;
  $('tempoVal').textContent = `${tempoPct.toFixed(2)}%`;
  backing.playbackRate = 1 + (tempoPct/100);
});

$('btnAudition').onclick = ()=>{
  if (!recordedBlob || !backing.src) { alert('Brak nagrania lub podkładu.'); return; }
  resyncBackingToPlayer();
  safePlay(backing); safePlay(player);
  setAuditionButtons(true); isAuditioning = true;
  startAutoResync();
};
$('btnStopAud').onclick = ()=> stopAudition();

player.addEventListener('ended', ()=> stopAudition());
backing.addEventListener('ended', ()=> stopAudition());
player.addEventListener('pause', ()=> { if (!backing.paused) backing.pause(); stopAutoResync(); });

function stopAudition(){
  try{ player.pause(); }catch(_){}
  try{ backing.pause(); }catch(_){}
  stopAutoResync();
  setAuditionButtons(false); isAuditioning = false;
}
function setAuditionButtons(running){
  $('btnAudition').disabled = running;
  $('btnStopAud').disabled  = !running;
}
function startAutoResync(){
  stopAutoResync();
  resyncTimer = setInterval(()=>{
    const pd = isFinite(player.duration) ? player.duration : 0;
    const bd = isFinite(backing.duration) ? backing.duration : 0;
    if ((pd && player.currentTime >= pd - 0.05) || (bd && backing.currentTime >= bd - 0.05)) {
      stopAudition(); return;
    }
    const target = player.currentTime + offsetMs/1000;
    const diff = Math.abs((backing.currentTime||0) - target);
    if (diff > 0.12) backing.currentTime = Math.max(0, target);
  }, 400);
}
function stopAutoResync(){ if (resyncTimer){ clearInterval(resyncTimer); resyncTimer=null; } }
function resyncBackingToPlayer(){
  const target = player.currentTime + offsetMs/1000;
  backing.currentTime = Math.max(0, target);
  backing.playbackRate = 1 + (tempoPct/100);
}
function safePlay(elm){ elm.play().catch(()=>{}); }

/* ========= WYSYŁKA ========= */
$('btnSendAll').onclick = async ()=>{
  if(!recordedBlob){ alert('Najpierw nagraj.'); return; }
  try{
    const sendBtn = $('btnSendAll');
    sendBtn.textContent = 'Wysyłam…';
    sendBtn.classList.add('blink');
    sendBtn.disabled = true;

    log('Konwersja na base64…');
    const base64 = await blobToBase64(recordedBlob);

    log('Wysyłanie na Drive…');
    const up = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'upload', fileBase64: base64, mimeType, fileName })
    }).then(r=>r.json());
    if(!up.ok) throw new Error(up.error || 'Upload failed');

    $('fileIdSpan').textContent = up.fileId; $('fileIdLine').hidden = true; // trzymamy ukryte dla uczniów
    log(`Upload OK, fileId: ${up.fileId}`);

    // payload do SPM (z echem tytułu i podkładu)
    metaToSend = {
      ver: 1, ts: Date.now(),
      imie: student.imie, nazwisko: student.nazwisko, email: student.email,
      miejscowosc: student.miejscowosc, tytul: student.tytul,
      trackUrl: student.trackUrl,
      durationMs,
      fileId: up.fileId, viewLink: up.viewLink, downloadLink: up.downloadLink,
      fileName, mimeType
    };

    // zapis dodatkowych metadanych (jak było)
    log('Zapis do Sheets…');
    const m = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'meta', meta: metaToSend })
    }).then(r=>r.json());
    if(!m.ok) throw new Error(m.error || 'Sheets error');
    log('Sheets: OK (wiersz '+m.row+')');

    // pokaż link-przycisk powrotu
    if (PARENT_URL) {
      const spmParam = encodeURIComponent(JSON.stringify(metaToSend));
      $('aReturn').href = PARENT_URL + (PARENT_URL.includes('?') ? '&' : '?') + 'spm=' + spmParam;
      $('aReturn').style.display = 'inline-flex';
    }

    setBanner('Wysłano. Kliknij:  ➜  „Wróć do SPM – Potwierdź wysyłkę i Zapisz”.');
    stepActive('step3');

    sendBtn.classList.remove('blink');
    sendBtn.textContent = 'Wyślij';
    sendBtn.disabled = false;

  }catch(e){
    $('btnSendAll').classList.remove('blink');
    $('btnSendAll').textContent = 'Wyślij';
    $('btnSendAll').disabled = false;
    log('BŁĄD: '+(e.message||e));
    alert('Nie udało się dokończyć wysyłki: '+(e.message||e));
  }
};
</script>
</body>
</html>
