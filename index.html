<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM ‚Äî nagrywanie</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#111; color:#eee; }
    h1,h2{ margin: 0 0 12px 0; }
    h2{ margin-top: 22px; }
    input[type="range"]{ width: 260px; }
    button{ padding:10px 14px; border-radius:8px; border:0; background:#2e7d32; color:#fff; cursor:pointer; }
    button.secondary{ background:#444; }
    button.warn{ background:#1565c0; }
    button.danger{ background:#8e1b1b; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    a.inline { display:inline-block; margin:6px 8px 0 0; }
    .card{ border:1px solid #272727; border-radius:12px; padding:16px; margin:18px 0; background:#141414; }
    #log{ background:#0c0c0c; border:1px solid #222; border-radius:12px; padding:12px; white-space:pre-wrap; min-height:120px; }
    .note{ opacity:.85; font-size:.92rem; }
    .val{ display:inline-block; min-width:70px; text-align:right; opacity:.9; }
    .inline-controls{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    .hidden-audio { display:none; }
    .progress-row{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .progress-row label{ min-width:120px; opacity:.9; }
    .progress-row input[type="range"]{ width: 360px; }
    .time{ font-variant-numeric: tabular-nums; opacity:.9; min-width:80px; text-align:right; }
  </style>
</head>
<body>
  <h1>SPM ‚Äì nagrywanie</h1>

  <h2>Podk≈Çad (ods≈Çuch)</h2>
  <div class="card">
    <div class="inline-controls" style="margin-top:8px">
      <label for="trackVol">G≈Ço≈õno≈õƒá podk≈Çadu</label>
      <input id="trackVol" type="range" min="0" max="1" step="0.01" value="0.7" />
      <span id="trackVolVal" class="val">70%</span>
    </div>
    <div class="progress-row">
      <label for="backingSeek">Postƒôp podk≈Çadu</label>
      <input id="backingSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="backingTime" class="time">0:00 / 0:00</span>
    </div>
    <audio id="backing" preload="auto" class="hidden-audio"></audio>
    <div class="note">Podk≈Çad gra w s≈Çuchawkach podczas nagrania. <b>Nie zapisuje siƒô</b> w pliku ‚Äî nagrywa siƒô tylko mikrofon.</div>
  </div>

  <h2>Nagrywanie</h2>
  <div class="card">
    <div class="inline-controls">
      <button id="btnStart">Start</button>
      <button id="btnStop" class="secondary" disabled>Stop</button>
      <button id="btnDownload" class="secondary" disabled>Pobierz</button>
    </div>
    <div class="progress-row">
      <label for="playerSeek">Postƒôp nagrania</label>
      <input id="playerSeek" type="range" min="0" max="0" step="0.01" value="0" />
      <span id="playerTime" class="time">0:00 / 0:00</span>
    </div>
    <audio id="player" class="hidden-audio"></audio>
    <div style="margin-top:14px" class="inline-controls">
      <button id="btnAudition" class="warn" disabled>Ods≈Çuchaj (z podk≈Çadem)</button>
      <button id="btnStopAud" class="danger" disabled>Zatrzymaj ods≈Çuch</button>
      <label for="offsetMs">Korekta przesuniƒôcia</label>
      <input id="offsetMs" type="range" min="-800" max="800" step="10" value="0" />
      <span id="offsetVal" class="val">0 ms</span>
      <label for="tempoPct">Korekta tempa</label>
      <input id="tempoPct" type="range" min="-1" max="1" step="0.05" value="0" />
      <span id="tempoVal" class="val">0.00%</span>
    </div>
    <div class="note">Je≈õli czujesz ‚Äûrozjazd‚Äù, u≈ºyj suwak√≥w: <b>przesuniƒôcie</b> i <b>tempo</b> ‚Äî dzia≈ÇajƒÖ tylko w ods≈Çuchu.</div>
  </div>

  <h2>Wy≈õlij</h2>
  <div class="card">
    <button id="btnSendAll" class="warn" disabled>Wy≈õlij</button>
    <div style="margin-top:10px">
      <a id="aView" class="inline" href="#" target="_blank" rel="noopener" hidden>üîé PodglƒÖd (Drive)</a>
      <a id="aDl" class="inline" href="#" target="_blank" rel="noopener" hidden>‚¨áÔ∏è Pobierz (direct)</a>
      <div id="fileIdLine" class="note" hidden>fileId: <span id="fileIdSpan"></span></div>
    </div>
  </div>

  <h2>Log</h2>
  <pre id="log"></pre>

<script>
const FN_URL = '/.netlify/functions/spm';
const PARENT_TARGET = '*'; // rodzic filtruje origin

let mediaRecorder, chunks=[], recordedBlob=null, startedAt=0, durationMs=0;
let fileName='', mimeType='audio/webm';
const backing=document.getElementById('backing'), player=document.getElementById('player');
const backingSeek=document.getElementById('backingSeek'), playerSeek=document.getElementById('playerSeek');
const backingTime=document.getElementById('backingTime'), playerTime=document.getElementById('playerTime');
let offsetMs=0, tempoPct=0, resyncTimer=null, rafId=null, isAuditioning=false;

const $ = id => document.getElementById(id);
function log(m){ $('log').textContent += m+'\n'; }
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
function sanitize(s){ return (s||'').trim().replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,''); }
function blobToBase64(b){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(b); }); }
function parseQ(){ try{ const q=new URLSearchParams(location.search).get('q'); return q?JSON.parse(decodeURIComponent(q)):{} }catch(_){ return {} } }
function fmt(t){ if(!isFinite(t)||t<0)t=0; const m=Math.floor(t/60), s=Math.floor(t%60); return `${m}:${String(s).padStart(2,'0')}`; }
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

let student={imie:'',nazwisko:'',email:'',miejscowosc:'',tytul:'',trackUrl:''};
(function init(){
  const q=parseQ();
  student={ imie:q.imie||'', nazwisko:q.nazwisko||'', email:q.email||'', miejscowosc:q.miejscowosc||'', tytul:q.tytul||'', trackUrl:q.trackUrl||'' };
  if(student.trackUrl){ backing.src=student.trackUrl; backing.load(); log('Podk≈Çad ustawiony z WIX (#podkladUrl).'); }
})();

function refreshProgress(){
  const bd=isFinite(backing.duration)?backing.duration:0, bc=isFinite(backing.currentTime)?backing.currentTime:0;
  backingSeek.max=bd||0; if(document.activeElement!==backingSeek) backingSeek.value=bc;
  backingTime.textContent=`${fmt(bc)} / ${fmt(bd)}`;
  const pd=isFinite(player.duration)?player.duration:(durationMs?durationMs/1000:0), pc=isFinite(player.currentTime)?player.currentTime:0;
  playerSeek.max=pd||0; if(document.activeElement!==playerSeek) playerSeek.value=pc;
  playerTime.textContent=`${fmt(pc)} / ${fmt(pd)}`;
  rafId=requestAnimationFrame(refreshProgress);
}
rafId=requestAnimationFrame(refreshProgress);

playerSeek.addEventListener('input', ()=>{ const pd=isFinite(player.duration)?player.duration:0; const t=clamp(parseFloat(playerSeek.value)||0,0,pd||1e9); player.currentTime=t; });
backingSeek.addEventListener('input', ()=>{ const bd=isFinite(backing.duration)?backing.duration:0; const bt=clamp(parseFloat(backingSeek.value)||0,0,bd||1e9); const tp=clamp(bt - offsetMs/1000, 0, (isFinite(player.duration)?player.duration:1e9)); player.currentTime=tp; });

$('trackVol').addEventListener('input', e=>{ const v=parseFloat(e.target.value||'0.7'); backing.volume=v; $('trackVolVal').textContent=Math.round(v*100)+'%'; });
backing.volume=parseFloat($('trackVol').value||'0.7'); backing.preservesPitch = backing.mozPreservesPitch = backing.webkitPreservesPitch = true;

$('btnStart').onclick=async()=>{
  try{
    const mic=await navigator.mediaDevices.getUserMedia({audio:true});
    chunks=[]; recordedBlob=null; durationMs=0; startedAt=Date.now();
    mediaRecorder=new MediaRecorder(mic,{mimeType});
    mediaRecorder.ondataavailable=e=>{ if(e.data&&e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop=()=>{
      durationMs=Date.now()-startedAt;
      recordedBlob=new Blob(chunks,{type:mimeType});
      player.src=URL.createObjectURL(recordedBlob);
      const i=sanitize(student.imie), n=sanitize(student.nazwisko), t=sanitize(student.tytul);
      fileName=`SPM-${ts()}-${i||'imie'}-${n||'nazw'}-${t||'tytul'}.webm`;
      $('btnDownload').disabled=false; $('btnSendAll').disabled=false; $('btnAudition').disabled=false; $('btnStopAud').disabled=true;
      log(`Nagranie gotowe. Czas ~ ${durationMs} ms; rozmiar ~ ${Math.round(recordedBlob.size/1024)} KB`);
    };
    try{ if(backing.src){ backing.currentTime=0; await backing.play(); } }catch(e){ log('Uwaga: podk≈Çad nie wystartowa≈Ç ('+e.message+').'); }
    mediaRecorder.start(); $('btnStart').disabled=true; $('btnStop').disabled=false; log('Nagrywanie‚Ä¶ (podk≈Çad tylko w s≈Çuchawkach)');
  }catch(e){ alert('Brak dostƒôpu do mikrofonu.'); log('B≈ÅƒÑD mikrofon: '+e.message); }
};
$('btnStop').onclick=()=>{ if(mediaRecorder&&mediaRecorder.state==='recording'){ mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop()); $('btnStart').disabled=false; $('btnStop').disabled=true; try{backing.pause()}catch(_){}}; };
$('btnDownload').onclick=()=>{ if(!recordedBlob)return; const a=document.createElement('a'); a.href=URL.createObjectURL(recordedBlob); a.download=fileName; a.click(); };

$('offsetMs').addEventListener('input', e=>{ offsetMs=parseInt(e.target.value,10)||0; $('offsetVal').textContent=`${offsetMs} ms`; });
$('tempoPct').addEventListener('input', e=>{ tempoPct=parseFloat(e.target.value)||0; $('tempoVal').textContent=`${tempoPct.toFixed(2)}%`; backing.playbackRate=1+(tempoPct/100); });

$('btnAudition').onclick=()=>{ if(!recordedBlob||!backing.src){ alert('Brak nagrania lub podk≈Çadu.'); return; } backing.currentTime=player.currentTime+offsetMs/1000; backing.playbackRate=1+(tempoPct/100); backing.play().catch(()=>{}); player.play().catch(()=>{}); $('btnAudition').disabled=true; $('btnStopAud').disabled=false; isAuditioning=true; };
$('btnStopAud').onclick=()=>{ try{player.pause()}catch(_){ } try{backing.pause()}catch(_){ } $('btnAudition').disabled=false; $('btnStopAud').disabled=true; isAuditioning=false; };
player.addEventListener('ended', ()=>$('btnStopAud').click());
backing.addEventListener('ended', ()=>$('btnStopAud').click());

$('btnSendAll').onclick=async()=>{
  if(!recordedBlob){ alert('Najpierw nagraj.'); return; }
  try{
    log('Konwersja na base64‚Ä¶');
    const base64=await blobToBase64(recordedBlob);

    log('Wysy≈Çanie na Drive‚Ä¶');
    const up = await fetch(FN_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'upload',fileBase64:base64,mimeType,fileName})}).then(r=>r.json());
    if(!up.ok) throw new Error(up.error||'Upload failed');
    $('aView').href=up.viewLink; $('aView').hidden=false;
    $('aDl').href=up.downloadLink; $('aDl').hidden=false;
    $('fileIdSpan').textContent=up.fileId; $('fileIdLine').hidden=false;
    log(`Upload OK, fileId: ${up.fileId}`);

    const meta={ver:1,ts:Date.now(),imie:student.imie,nazwisko:student.nazwisko,email:student.email,miejscowosc:student.miejscowosc,tytul:student.tytul,durationMs,fileId:up.fileId,viewLink:up.viewLink,downloadLink:up.downloadLink,fileName,mimeType};
    log('Zapis do Sheets‚Ä¶');
    const m = await fetch(FN_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'meta',meta})}).then(r=>r.json());
    if(!m.ok) throw new Error(m.error||'Sheets error');
    log('Sheets: OK (wiersz '+m.row+')');

    // 1) postMessage do rodzica
    try{ if(window.opener){ window.opener.postMessage({type:'spmUpload',payload:meta}, PARENT_TARGET); } }catch(_){}

    // 2) nak≈Çadka info
    document.body.insertAdjacentHTML('beforeend','<div id="sentOverlay" style="position:fixed;inset:0;background:#0008;display:grid;place-items:center;font:600 16px system-ui">Wys≈Çano. Okno zamknie siƒô automatycznie‚Ä¶</div>');

    // 3) samodomkniƒôcie (gdy dozwolone)
    try{ window.close(); }catch(_){}
    setTimeout(()=>{ try{ window.open('','_self'); window.close(); }catch(_){ } }, 300);

  }catch(e){
    log('B≈ÅƒÑD: '+(e.message||e));
    alert('Nie uda≈Ço siƒô doko≈Ñczyƒá wysy≈Çki: '+(e.message||e));
  }
};
</script>
</body>
</html>
