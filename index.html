<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPM ‚Äî nagrywanie (ods≈Çuchowy podk≈Çad)</title>
  <style>
    :root { color-scheme: dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; background:#111; color:#eee; }
    h1,h2{ margin: 0 0 12px 0; }
    h2{ margin-top: 22px; }
    .row { display: grid; grid-template-columns: 160px 1fr; gap: 12px; margin: 8px 0; align-items:center; }
    input[type="text"], input[type="email"], input[type="url"] { width: 100%; padding: 10px; border-radius:8px; border:1px solid #333; background:#181818; color:#eee; }
    input[type="range"]{ width: 260px; }
    button{ padding:10px 14px; border-radius:8px; border:0; background:#2e7d32; color:#fff; cursor:pointer; }
    button.secondary{ background:#444; }
    button.warn{ background:#1565c0; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    a.inline { display:inline-block; margin:6px 8px 0 0; }
    .card{ border:1px solid #272727; border-radius:12px; padding:16px; margin:18px 0; background:#141414; }
    #log{ background:#0c0c0c; border:1px solid #222; border-radius:12px; padding:12px; white-space:pre-wrap; min-height:120px; }
    .note{ opacity:.85; font-size:.92rem; }
    .val{ display:inline-block; min-width:70px; text-align:right; opacity:.9; }
    .inline-controls{ display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>SPM ‚Äì nagrywanie</h1>

  <!-- 1) Dane ucznia -->
  <div class="card">
    <div class="row"><label>Imiƒô</label><input id="imie" type="text" /></div>
    <div class="row"><label>Nazwisko</label><input id="nazwisko" type="text" /></div>
    <div class="row"><label>E-mail</label><input id="email" type="email" /></div>
    <div class="row"><label>Miejscowo≈õƒá</label><input id="miejscowosc" type="text" /></div>
    <div class="row"><label>Tytu≈Ç utworu</label><input id="tytul" type="text" /></div>
  </div>

  <!-- 2) Podk≈Çad (TYLKO ODS≈ÅUCH) -->
  <h2>Podk≈Çad (ods≈Çuch)</h2>
  <div class="card">
    <div class="row">
      <label>Plik z dysku</label>
      <input id="trackFile" type="file" accept="audio/*" />
    </div>
    <div class="row">
      <label>Albo link (MP3/WAV)</label>
      <input id="trackUrl" type="url" placeholder="https://‚Ä¶ (tylko ods≈Çuch; CORS nie jest wymagany)" />
    </div>
    <div class="inline-controls" style="margin-top:8px">
      <label for="trackVol">G≈Ço≈õno≈õƒá podk≈Çadu</label>
      <input id="trackVol" type="range" min="0" max="1" step="0.01" value="0.7" />
      <span id="trackVolVal" class="val">70%</span>
    </div>
    <audio id="backing" controls preload="auto" style="width:100%; margin-top:10px;"></audio>
    <div class="note">Podk≈Çad gra w s≈Çuchawkach podczas nagrywania. <b>Nie zapisuje siƒô</b> w pliku ‚Äî nagrywa siƒô tylko Tw√≥j mikrofon.</div>
  </div>

  <!-- 3) Nagrywanie -->
  <h2>Nagrywanie</h2>
  <div class="card">
    <div class="inline-controls">
      <button id="btnStart">Start</button>
      <button id="btnStop" class="secondary" disabled>Stop</button>
      <button id="btnDownload" class="secondary" disabled>Pobierz</button>
    </div>
    <div style="margin-top:12px">
      <audio id="player" controls></audio>
    </div>

    <!-- 3b) Ods≈Çuch po nagraniu z podk≈Çadem (opcjonalnie) -->
    <div style="margin-top:14px" class="inline-controls">
      <label><input id="playWithBacking" type="checkbox" /> Podk≈Çad przy ods≈Çuchu</label>
      <label for="offsetMs">Korekta przesuniƒôcia</label>
      <input id="offsetMs" type="range" min="-500" max="500" step="10" value="0" />
      <span id="offsetVal" class="val">0 ms</span>

      <label for="tempoPct">Korekta tempa</label>
      <input id="tempoPct" type="range" min="-0.5" max="0.5" step="0.05" value="0" />
      <span id="tempoVal" class="val">0.00%</span>
    </div>

    <div class="note">Je≈õli po ods≈Çuchu czujesz minimalny ‚Äûrozjazd‚Äù, u≈ºyj suwak√≥w: <b>przesuniƒôcie</b> (ms) i <b>tempo</b> (¬±0,5%) ‚Äî dzia≈Ça wy≈ÇƒÖcznie w ods≈Çuchu.</div>
  </div>

  <!-- 4) Wysy≈Çka na Drive -->
  <h2>Wysy≈Çka na Drive</h2>
  <div class="card">
    <button id="btnUpload" class="warn" disabled>Wy≈õlij na Drive</button>
    <div style="margin-top:10px">
      <a id="aView" class="inline" href="#" target="_blank" rel="noopener" hidden>üîé PodglƒÖd (Drive)</a>
      <a id="aDl" class="inline" href="#" target="_blank" rel="noopener" hidden>‚¨áÔ∏è Pobierz (direct)</a>
      <div id="fileIdLine" class="note" hidden>fileId: <span id="fileIdSpan"></span></div>
    </div>
  </div>

  <!-- 5) Przekazanie do SPM -->
  <h2>Przekazanie do SPM</h2>
  <div class="card">
    <button id="sendToSpmBtn" disabled>Wy≈õlij do SPM i zamknij</button>
    <button id="copyTokenBtn" class="secondary" disabled>Kopiuj token (awaryjnie)</button>
    <div class="note">‚ÄûWy≈õlij do SPM‚Äù zapisze tak≈ºe metadane do Google Sheets.</div>
  </div>

  <!-- Log -->
  <h2>Log</h2>
  <pre id="log"></pre>

<script>
/* ========= USTAWIENIA ========= */
const PARENT_ORIGIN = new URLSearchParams(location.search).get('parent') || '*';
const FN_URL = '/.netlify/functions/spm';

/* ========= ZMIENNE ========= */
let mediaRecorder, chunks = [], recordedBlob = null, startedAt = 0, durationMs = 0;
let fileName = '', mimeType = 'audio/webm';
let lastToken = '';

let micStream = null;
const backing = document.getElementById('backing');

/* Ods≈Çuch po nagraniu: synchronizacja */
let offsetMs = 0;          // przesuniƒôcie podk≈Çadu wzglƒôdem nagrania (tylko w ods≈Çuchu)
let tempoPct = 0;          // zmiana tempa podk≈Çadu w ods≈Çuchu (¬±0.5%)
let resyncTimer = null;    // drobne autodosynchronizacje

/* ========= POMOCNICZE ========= */
const $ = (id)=>document.getElementById(id);
function log(msg){ $('log').textContent += msg + '\n'; }
function ts(){ return new Date().toISOString().replace(/[:.]/g,'-'); }
function sanitize(s){ return (s||'').trim().replace(/\s+/g,'_').replace(/[^\w\-\.]+/g,''); }
function blobToBase64(blob){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result.split(',')[1]); fr.onerror=rej; fr.readAsDataURL(blob); }); }

/* ========= PODK≈ÅAD (tylko ods≈Çuch) ========= */
$('trackFile').addEventListener('change', e=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;
  backing.src = URL.createObjectURL(f);
  backing.load();
  log('Podk≈Çad: plik z dysku ustawiony.');
});
$('trackUrl').addEventListener('change', e=>{
  const url = (e.target.value||'').trim();
  if(!url) return;
  backing.src = url;
  backing.load();
  log('Podk≈Çad: link ustawiony.');
});
$('trackVol').addEventListener('input', e=>{
  const v = parseFloat(e.target.value||'0.7');
  backing.volume = v;
  $('trackVolVal').textContent = Math.round(v*100) + '%';
});
backing.volume = parseFloat($('trackVol').value||'0.7');
backing.preservesPitch = true; backing.mozPreservesPitch = true; backing.webkitPreservesPitch = true;

/* ========= NAGRYWANIE ========= */
$('btnStart').onclick = async ()=>{
  try{
    micStream = await navigator.mediaDevices.getUserMedia({audio:true});
    chunks = []; recordedBlob = null; durationMs = 0; startedAt = Date.now();

    mediaRecorder = new MediaRecorder(micStream, {mimeType});
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
    mediaRecorder.onstop = ()=>{
      durationMs = Date.now() - startedAt;
      recordedBlob = new Blob(chunks, {type:mimeType});
      $('player').src = URL.createObjectURL(recordedBlob);
      const i = sanitize($('imie').value), n = sanitize($('nazwisko').value), t = sanitize($('tytul').value);
      fileName = `SPM-${ts()}-${i||'imie'}-${n||'nazw'}-${t||'tytul'}.webm`;
      $('btnDownload').disabled = false;
      $('btnUpload').disabled = false;
      $('sendToSpmBtn').disabled = true;
      $('copyTokenBtn').disabled = true;
      log(`Nagranie gotowe. Czas ~ ${durationMs} ms; rozmiar ~ ${Math.round(recordedBlob.size/1024)} KB`);
    };

    // uruchom podk≈Çad (je≈õli ustawiony) i nagrywanie ‚Äì tylko ods≈Çuch
    try{
      if (backing.src) { backing.currentTime = 0; await backing.play(); }
    }catch(e){ log('Uwaga: podk≈Çad nie wystartowa≈Ç ('+e.message+').'); }
    mediaRecorder.start();

    $('btnStart').disabled = true;
    $('btnStop').disabled = false;
    log('Nagrywanie‚Ä¶ (podk≈Çad: tylko w s≈Çuchawkach)');
  }catch(e){
    alert('Brak dostƒôpu do mikrofonu.');
    log('B≈ÅƒÑD mikrofon: '+e.message);
  }
};

$('btnStop').onclick = ()=>{
  if(mediaRecorder && mediaRecorder.state==='recording'){
    mediaRecorder.stop();
    mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    $('btnStart').disabled = false;
    $('btnStop').disabled = true;
    try{ backing.pause(); }catch(_){}
  }
};

$('btnDownload').onclick = ()=>{
  if(!recordedBlob) return;
  const a=document.createElement('a'); a.href=URL.createObjectURL(recordedBlob); a.download=fileName; a.click();
};

/* ========= ODS≈ÅUCH PO NAGRANIU (z podk≈Çadem, opcjonalnie) ========= */
$('playWithBacking').addEventListener('change', ()=>{
  // je≈õli w≈ÇƒÖczasz w trakcie odtwarzania ‚Äì dopasuj
  if ($('playWithBacking').checked && !$('player').paused && backing.src) {
    resyncBackingToPlayer();
    safePlayBacking();
  } else {
    backing.pause();
  }
});

$('offsetMs').addEventListener('input', e=>{
  offsetMs = parseInt(e.target.value,10)||0;
  $('offsetVal').textContent = `${offsetMs} ms`;
  if ($('playWithBacking').checked && !$('player').paused) resyncBackingToPlayer();
});

$('tempoPct').addEventListener('input', e=>{
  tempoPct = parseFloat(e.target.value)||0;
  $('tempoVal').textContent = `${tempoPct.toFixed(2)}%`;
  backing.playbackRate = 1 + (tempoPct/100);
});

/* player steruje backingiem w ods≈Çuchu */
$('player').addEventListener('play', ()=>{
  if ($('playWithBacking').checked && backing.src) {
    resyncBackingToPlayer();
    safePlayBacking();
    startAutoResync();
  }
});
$('player').addEventListener('pause', ()=>{
  try{ backing.pause(); }catch(_){}
  stopAutoResync();
});
$('player').addEventListener('seeking', ()=>{ if($('playWithBacking').checked) resyncBackingToPlayer(); });
$('player').addEventListener('seeked',  ()=>{ if($('playWithBacking').checked) resyncBackingToPlayer(); });
$('player').addEventListener('ratechange', ()=>{ if($('playWithBacking').checked) resyncBackingToPlayer(); });
$('player').addEventListener('ended', ()=>{
  try{ backing.pause(); }catch(_){}
  stopAutoResync();
});

/* drobne autodosynchronizacje (skoki tylko gdy r√≥≈ºnica > 120 ms) */
function startAutoResync(){
  stopAutoResync();
  resyncTimer = setInterval(()=>{
    if (!$('playWithBacking').checked) return;
    const target = $('player').currentTime + offsetMs/1000;
    const diff = Math.abs((backing.currentTime||0) - target);
    if (diff > 0.12) backing.currentTime = Math.max(0, target);
  }, 500);
}
function stopAutoResync(){ if(resyncTimer){ clearInterval(resyncTimer); resyncTimer=null; } }
function resyncBackingToPlayer(){
  const target = $('player').currentTime + offsetMs/1000;
  backing.currentTime = Math.max(0, target);
  backing.playbackRate = 1 + (tempoPct/100);
}
function safePlayBacking(){ backing.play().catch(()=>{}); }

/* ========= UPLOAD NA DRIVE ========= */
$('btnUpload').onclick = async ()=>{
  if(!recordedBlob){ alert('Najpierw nagraj.'); return; }
  try{
    log('Konwersja na base64‚Ä¶');
    const base64 = await blobToBase64(recordedBlob);

    log('Wysy≈Çanie do proxy‚Ä¶');
    const r = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'upload', fileBase64: base64, mimeType, fileName })
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Upload failed');

    $('aView').href = j.viewLink; $('aView').hidden = false;
    $('aDl').href   = j.downloadLink; $('aDl').hidden = false;
    $('fileIdSpan').textContent = j.fileId; $('fileIdLine').hidden = false;
    log(`Upload OK, fileId: ${j.fileId}`);

    // zbuduj meta i token
    const meta = {
      imie: $('imie').value, nazwisko: $('nazwisko').value, email: $('email').value,
      miejscowosc: $('miejscowosc').value, tytul: $('tytul').value,
      durationMs, fileId: j.fileId, viewLink: j.viewLink, downloadLink: j.downloadLink,
      fileName, mimeType
    };
    lastToken = 'SPM:' + btoa(JSON.stringify(meta));
    $('sendToSpmBtn').disabled = false;
    $('copyTokenBtn').disabled = false;
  }catch(e){
    log('B≈ÅƒÑD upload: '+e.message);
    alert('Upload nieudany: '+e.message);
  }
};

/* ========= ZAPIS DO SHEETS + WY≈öLIJ DO SPM ========= */
$('sendToSpmBtn').onclick = async ()=>{
  if(!lastToken){ alert('Brak tokena ‚Äì wy≈õlij najpierw na Drive.'); return; }
  try{
    const meta = JSON.parse(atob(lastToken.replace(/^SPM:/,'')));
    log('Zapis do Sheets‚Ä¶');
    const r = await fetch(FN_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'meta', meta })
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Sheets error');
    log('Sheets: OK (wiersz '+j.row+')');

    // Przeka≈º dane do strony SPM (Wix)
    if(window.opener){
      window.opener.postMessage({ type:'spmUpload', payload: meta }, PARENT_ORIGIN);
    }
    try{ window.close(); }catch(_){}
  }catch(e){
    log('Sheets/SPM b≈ÇƒÖd: '+(e.message||e));
    alert('Nie uda≈Ço siƒô zapisaƒá do Sheets: '+(e.message||e));
  }
};

/* ========= KOPIOWANIE TOKENU ========= */
$('copyTokenBtn').onclick = async ()=>{
  if(!lastToken){ alert('Brak tokena.'); return; }
  await navigator.clipboard.writeText(lastToken);
  log('Skopiowano token.');
};
</script>
</body>
</html>
