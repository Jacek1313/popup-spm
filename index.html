<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SPM ‚Äì nagrywanie</title>
  <style>
    :root { --bg:#0f1115; --fg:#e7e7e7; --muted:#9aa3b2; --accent:#39d98a; --card:#171a22; --danger:#ff6b6b; }
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    .wrap{max-width:920px;margin:24px auto;padding:0 16px;}
    h1{font-size:28px;margin:12px 0 24px}
    .card{background:var(--card);border-radius:12px;padding:16px 18px;margin-bottom:14px;box-shadow:0 0 0 1px rgba(255,255,255,.03) inset}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:#2a2f3a;border:0;color:var(--fg);padding:10px 16px;border-radius:8px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#041b11;font-weight:700}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:13px}
    .log{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;background:#0b0d11;border-radius:10px;padding:12px;min-height:140px;white-space:pre-wrap}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#223; padding:6px 10px;border-radius:8px}
    a{color:#b9d0ff}
    .hidden{display:none}
    /* ukrycie standardowych przycisk√≥w audio, pozostaw pasek */
    audio{width:100%;}
    audio::-webkit-media-controls-play-button{display:none!important}
    audio::-webkit-media-controls-start-playback-button{display:none!important}
    audio[controls]::-webkit-media-controls-timeline{margin-left:0}
    audio[controls]::-webkit-media-controls-panel{background:transparent}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>SPM ‚Äî nagrywanie</h1>

    <!-- 1) Dane ucznia i podk≈Çad -->
    <div class="card">
      <div class="row" style="gap:8px 20px">
        <div>
          <div class="hint">Imiƒô</div>
          <input id="imie" class="btn" style="min-width:220px;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
        <div>
          <div class="hint">Nazwisko</div>
          <input id="nazwisko" class="btn" style="min-width:220px;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
        <div>
          <div class="hint">E-mail</div>
          <input id="email" class="btn" style="min-width:260px;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
        <div>
          <div class="hint">Miejscowo≈õƒá</div>
          <input id="miejscowosc" class="btn" style="min-width:220px;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
        <div>
          <div class="hint">Tytu≈Ç utworu</div>
          <input id="tytul" class="btn" style="min-width:260px;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
        <div style="flex:1 1 100%">
          <div class="hint">URL podk≈Çadu (z Twojej strony SPM/Wix)</div>
          <input id="podkladUrl" class="btn" placeholder="https://..." style="width:100%;background:#10131a;color:#eee;border:1px solid #2b3240">
        </div>
      </div>
    </div>

    <!-- 2) Nagrywanie + ods≈Çuch (z podk≈Çadem) -->
    <div class="card">
      <div class="hint" style="margin-bottom:6px">Nagrywanie</div>
      <div class="row">
        <button id="startBtn" class="btn">Start</button>
        <button id="stopBtn" class="btn">Stop</button>
        <button id="pobierzBtn" class="btn">Pobierz</button>
        <span id="timeLabel" class="pill">0:00</span>
      </div>

      <div style="margin-top:10px">
        <audio id="backing" controls controlslist="nodownload noplaybackrate"></audio>
        <div class="hint">Podk≈Çad ‚Äì bƒôdzie s≈Çyszalny tylko w ods≈Çuchu.</div>
      </div>

      <div style="margin-top:10px">
        <audio id="preview" controls controlslist="nodownload noplaybackrate"></audio>
        <div class="hint">Twoje nagranie</div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="playTogetherBtn" class="btn">Ods≈Çuch (podk≈Çad + nagranie)</button>
      </div>
    </div>

    <!-- 3) Wysy≈Çka -->
    <div class="card">
      <div class="hint" style="margin-bottom:8px">Wy≈õlij nagranie + metadane</div>
      <div class="row">
        <button id="wyslijBtn" class="btn primary">Wy≈õlij</button>

        <div id="linksBox" class="row hidden">
          <span class="pill">üîé <a id="viewLink" target="_blank" rel="noopener">PodglƒÖd (Drive)</a></span>
          <span class="pill">‚¨áÔ∏è <a id="downloadLink" target="_blank" rel="noopener">Pobierz (direct)</a></span>
        </div>
      </div>
      <div class="hint" id="fileIdHint" style="margin-top:6px"></div>
    </div>

    <!-- 4) Log -->
    <div class="card">
      <div class="hint" style="margin-bottom:6px">Log</div>
      <div id="log" class="log"></div>
    </div>
  </div>

  <script>
    // === konfiguracja ===
    const PROXY = location.origin + '/.netlify/functions/spm'; // Tw√≥j proxy na Netlify
    const qs = new URLSearchParams(location.search);
    const parentParam = qs.get('parent');
    const PARENT_ORIGIN = parentParam ? new URL(parentParam).origin : '*';

    // === elementy ===
    const logEl = document.querySelector('#log');
    const imieEl = document.querySelector('#imie');
    const nazwiskoEl = document.querySelector('#nazwisko');
    const emailEl = document.querySelector('#email');
    const miejscEl = document.querySelector('#miejscowosc');
    const tytulEl = document.querySelector('#tytul');
    const podkladEl = document.querySelector('#podkladUrl');
    const backing = document.querySelector('#backing');
    const preview = document.querySelector('#preview');
    const timeLabel = document.querySelector('#timeLabel');
    const linksBox = document.querySelector('#linksBox');
    const viewLinkA = document.querySelector('#viewLink');
    const downloadLinkA = document.querySelector('#downloadLink');
    const fileIdHint = document.querySelector('#fileIdHint');

    const startBtn = document.querySelector('#startBtn');
    const stopBtn = document.querySelector('#stopBtn');
    const pobierzBtn = document.querySelector('#pobierzBtn');
    const wyslijBtn = document.querySelector('#wyslijBtn');
    const playTogetherBtn = document.querySelector('#playTogetherBtn');

    // === stan nagrywania ===
    let mediaRecorder = null;
    let recChunks = [];
    let recStart = 0;
    let lastBlob = null;
    let lastFilename = '';

    function log(line){ logEl.textContent += line + '\n'; logEl.scrollTop = logEl.scrollHeight; }
    function hhmmss(ms){
      const s = Math.round(ms/1000);
      const m = Math.floor(s/60);
      const r = s%60;
      return `${m}:${(''+r).padStart(2,'0')}`;
    }

    // wstƒôpny komunikat
    log('Podk≈Çad ustawiony z pola #podkladUrl (Wix).');
    log('Uwaga: podk≈Çad gra TYLKO w ods≈Çuchu.');

    // start nagrywania
    startBtn.onclick = async () => {
      try{
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recChunks = [];
        mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
        mediaRecorder.ondataavailable = e => e.data && recChunks.push(e.data);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(recChunks, {type:'audio/webm'});
          lastBlob = blob;
          preview.src = URL.createObjectURL(blob);
          preview.load();
        };
        mediaRecorder.start();
        recStart = Date.now();
        log('Nagrywanie‚Ä¶');
        tickTime();
      }catch(err){
        log('B≈ÅƒÑD start: ' + err.message);
        alert('Nie uda≈Ço siƒô uruchomiƒá nagrywania (mikrofon?)');
      }
    };

    // zliczanie czasu
    let tickTimer=null;
    function tickTime(){
      clearInterval(tickTimer);
      tickTimer = setInterval(()=>{
        if (mediaRecorder && mediaRecorder.state==='recording'){
          timeLabel.textContent = hhmmss(Date.now()-recStart);
        }
      },200);
    }

    // stop nagrywania
    stopBtn.onclick = () => {
      if (!mediaRecorder) return;
      try {
        const ms = Date.now() - recStart;
        timeLabel.textContent = hhmmss(ms);
        mediaRecorder.stop();
        log(`Nagranie OK. Czas ~ ${ms} ms; rozmiar ~ (wkr√≥tce) KB`);
      }catch(e){}
      mediaRecorder = null;
      clearInterval(tickTimer);
      // zatrzymaj podk≈Çad je≈õli gra
      try{ backing.pause(); backing.currentTime = 0; }catch(_){}
    };

    // pobierz nagranie lokalnie
    pobierzBtn.onclick = async () => {
      if(!lastBlob){ alert('Brak nagrania'); return; }
      const name = makeFileName();
      const a = document.createElement('a');
      a.href = URL.createObjectURL(lastBlob);
      a.download = name;
      a.click();
    };

    // ods≈Çuch razem
    playTogetherBtn.onclick = () => {
      // ustaw podk≈Çad z pola
      setBackingFromInput();
      if (!lastBlob) { alert('Najpierw nagraj'); return; }
      try {
        preview.currentTime = 0;
        backing.currentTime = 0;
        preview.play();
        backing.play();
      } catch (_){}
      // kiedy nagranie siƒô sko≈Ñczy ‚Äì zatrzymaj podk≈Çad, by nie ‚Äûpƒôtli≈Ç‚Äù
      const onEnded = () => {
        try { backing.pause(); } catch(_){}
        preview.removeEventListener('ended', onEnded);
      };
      preview.addEventListener('ended', onEnded);
    };

    function setBackingFromInput(){
      const u = (podkladEl.value||'').trim();
      if (u && backing.src !== u) {
        backing.src = u;
        backing.load();
      }
    }

    // Wy≈õlij ‚Äì 1 przycisk: upload + sheets + postMessage + zamkniƒôcie
    wyslijBtn.onclick = async () => {
      if(!lastBlob){ alert('Brak nagrania'); return; }
      setBackingFromInput();

      // metadane z formularza
      const meta = {
        imie      : (imieEl.value||'').trim(),
        nazwisko  : (nazwiskoEl.value||'').trim(),
        email     : (emailEl.value||'').trim(),
        miejscowosc: (miejscEl.value||'').trim(),
        tytul     : (tytulEl.value||'').trim(),
        durationMs: preview.duration ? Math.round(preview.duration*1000) : undefined,
        mimeType  : lastBlob.type || 'audio/webm',
        fileName  : makeFileName(),
        podkladUrl: (podkladEl.value||'').trim()
      };

      // konwersja do base64
      log('Konwersja na base64‚Ä¶');
      const b64 = await blobToDataUrl(lastBlob); // data:audio/webm;base64,XXXX
      // upload do Drive
      log('Wysy≈Çanie na Drive‚Ä¶');
      let uploadRes;
      try{
        uploadRes = await fetch(PROXY, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action:'upload',
            file: b64,
            mime: meta.mimeType,
            name: meta.fileName
          })
        }).then(r=>r.json());
      }catch(e){
        alert('B≈ÇƒÖd uploadu (proxy).'); log('B≈ÅƒÑD upload: ' + e.message); return;
      }
      if(!uploadRes || !uploadRes.ok){
        alert('Upload nieudany: ' + (uploadRes && uploadRes.error)); 
        log('B≈ÅƒÑD upload: ' + JSON.stringify(uploadRes)); 
        return;
      }
      log(`Upload OK, fileId: ${uploadRes.fileId}`);
      const fileId = uploadRes.fileId || '';
      const viewLink = uploadRes.viewLink || '';
      const downloadLink = uploadRes.downloadLink || '';
      fileIdHint.textContent = `fileId: ${fileId}`;
      // poka≈º linki
      linksBox.classList.remove('hidden');
      viewLinkA.href = viewLink;
      downloadLinkA.href = downloadLink;

      // zapis do Sheets
      log('Zapis do Sheets‚Ä¶');
      let sheetsRes;
      try{
        sheetsRes = await fetch(PROXY, {
          method:'POST',
          headers:{ 'Content-Type':'text/plain;charset=utf-8' },
          body: JSON.stringify({
            action:'meta',
            meta: {
              ...meta,
              fileId, viewLink, downloadLink
            }
          })
        }).then(r=>r.json());
      }catch(e){
        alert('B≈ÇƒÖd zapisu do Sheets (proxy).'); log('B≈ÅƒÑD meta: ' + e.message); return;
      }
      if(!sheetsRes || !sheetsRes.ok){
        alert('Nie uda≈Ço siƒô zapisaƒá do Sheets: ' + (sheetsRes && sheetsRes.error));
        log('B≈ÅƒÑD meta: ' + JSON.stringify(sheetsRes));
        return;
      }
      log(`Sheets: OK (wiersz ${sheetsRes.row||'?'}).`);

      // wy≈õlij paczkƒô do SPM + domknij
      const payload = { ...meta, fileId, viewLink, downloadLink };
      try {
        if (window.opener) {
          window.opener.postMessage({ type:'spmUpload', payload }, PARENT_ORIGIN);
        }
      } catch(_){}
      // w≈Çasne zamkniƒôcie
      setTimeout(() => { try{ window.close(); } catch(_){ } }, 50);
      // dodatkowy awaryjny trick
      setTimeout(() => { try{ window.open('','_self'); window.close(); } catch(_){ } }, 300);
    };

    function makeFileName(){
      const safe = (tytulEl.value||'spm').trim().replace(/[^\p{L}\p{N}\-_. ]+/gu,'_').replace(/\s+/g,'-');
      const stamp = new Date().toISOString().replace(/[:.]/g,'-');
      return `SPM-${stamp}-${safe}.webm`;
    }

    // bezpieczna konwersja do dataURL (unikamy btoa dla UTF-8)
    function blobToDataUrl(blob){
      return new Promise((resolve,reject)=>{
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result); // "data:audio/webm;base64,AAAA..."
        fr.onerror = reject;
        fr.readAsDataURL(blob);
      });
    }
  </script>
</body>
</html>
